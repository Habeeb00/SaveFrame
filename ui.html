<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SaveFrame</title>
    <style>
      :root {
        /* Light Mode Variables */
        --primary-color: #0d99ff;
        --first-color: #2c2c2c;
        --second-color: #7f7f7f;
        --third-color: #b3b3b3;
        --heading-color: #161616;
        --secondary-color: #888888;
        --bg-color: #ffffff;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --active-color: #d4d4d4;
        --hover-color: #f0f0f0;
        --accent-color: #0d99ff;
        --star-color: rgb(243, 243, 39);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --figma-bg: #f5f5f5;
        --figma-text: #333333;
        --figma-secondary: #7f7f7f;
        --figma-border: #e5e5e5;
        --figma-hover: #e8e8e8;
        --figma-blue: #18a0fb;
        --figma-blue-hover: #0d8de3;
        --tooltip-delay: 600ms;
        --error-color: #ff3b30;
        --button-color: #2c2c2e;
        --collection-header-bg: #2c2c2e;
      }

      :root {
        /* Common transition variables */
        --transition-speed: 0.3s;
        --transition-function: ease;
        --collection-transition-speed: 120ms;
        --collection-transition-function: cubic-bezier(0.2, 0, 0.38, 0.9);
      }

      [data-theme="dark"] {
        /* Dark Mode Variables */
        --heading-color: f5f5f5;
        --primary-color: #0a84ff;
        --third-color: #8e8e93;
        --text-color: #8e8e93;
        --text-primary: #8e8e93;
        --text-secondary: #aeaeb2;
        --bg-color: #1c1c1e;
        --star-color: #aeaeb2;
        --sidebar-bg: #2c2c2e;
        --border-color: #38383a;
        --hover-color: #3a3a3c;
        --active-color: #848484;
        --danger-color: #ff4530;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --button-color: #2c2c2e;
        --collection-header-bg: #2c2c2e;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        font-size: 10px;
        transition-property: background-color, border-color, color, opacity,
          transform, max-height;
        transition-duration: var(--transition-speed);
        transition-timing-function: var(--transition-function);
        max-width: 100%; /* Prevent content from overflowing horizontally */
      }

      /* Force content to stay within bounds */
      html,
      body {
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden !important; /* Force no horizontal scroll */
        overscroll-behavior: none;
      }

      .sidebar {
        width: 100% !important; /* Ensure sidebar takes exact width */
        max-width: 100%; /* Prevent sidebar overflow */
        overflow-x: hidden !important; /* Force no horizontal scroll in sidebar */
      }

      /* Fix collections container to prevent overflow */
      .collections-container {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden !important;
        padding-right: 0;
        box-sizing: border-box;
      }

      /* Ensure preset cards don't overflow */
      .preset-card {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden !important;
        box-sizing: border-box;
      }
      .header {
        color: var(--heading-color);
      }
      body {
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 0;
        font-size: 12px;
        color: var(--figma-text);
        background-color: var(--figma-bg);
        overflow-y: auto;
        overflow-x: hidden !important;
        overscroll-behavior: none;
      }

      /* Remove ALL scrollbars for horizontal scrolling */
      ::-webkit-scrollbar:horizontal,
      ::-webkit-scrollbar-horizontal {
        width: 0 !important;
        height: 0 !important;
        display: none !important;
      }

      /* Ensure no horizontal scrolling in Figma's Chrome-based environment */
      html,
      body {
        overflow-x: hidden;
        width: 100%;
      }

      .collections-container {
        overflow-x: hidden;
      }

      /* Tooltip styles */
      [data-tooltip] {
        position: relative;
      }

      [data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        transition-delay: 0ms;
        pointer-events: none;
        z-index: 1000;
      }

      [data-tooltip]:hover::after {
        opacity: 1;
        visibility: visible;
        transition-delay: var(--tooltip-delay);
      }

      /* Stylish scrollbar */
      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
        margin: 4px 0;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(150, 150, 150, 0.3);
        border-radius: 10px;
        transition: background 0.3s ease;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(150, 150, 150, 0.5);
      }

      /* Dark mode scrollbar */
      [data-theme="dark"]::-webkit-scrollbar-thumb {
        background: rgba(200, 200, 200, 0.2);
      }

      [data-theme="dark"]::-webkit-scrollbar-thumb:hover {
        background: rgba(200, 200, 200, 0.4);
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-secondary);
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        transition: background-color 0.3s, color 0.3s;
        font-size: 11px;
        overflow-x: hidden;
        overflow-y: auto;
        overscroll-behavior-x: none;
      }
      ::-webkit-scrollbar-horizontal {
        display: none;
      }

      .sidebar {
        background-color: var(--sidebar-bg);
        color: var(--text-primary);
        border-right: 1px solid transparent;
        height: 100vh;
        overflow-y: auto;
        width: 100%;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        /* More subtle appearance */
        backdrop-filter: blur(5px);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      }

      /* Subtler dark mode sidebar */
      [data-theme="dark"] .sidebar {
        background-color: rgba(44, 44, 46, 0.9);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
      }

      /* Main scrollable container */
      .main {
        padding: 0;
        flex: 1;
        overflow-y: auto;
        background-color: white;
      }

      button {
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--text-color);
        padding: 4px 8px;
        border-radius: 2px;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
        font-size: 10px;
      }

      button:hover {
        background-color: var(--figma-hover);
      }

      button.primary {
        background-color: var(--figma-blue);
        color: white;
        border-color: var(--figma-blue);
      }

      button.primary:hover {
        background-color: var(--figma-blue-hover);
        border-color: var(--figma-blue-hover);
      }

      button.danger {
        color: var(--danger-color);
      }

      button.danger:hover {
        background-color: rgba(242, 72, 34, 0.1);
      }

      button svg {
        margin-right: 4px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color);
      }

      /* Cleaned up toolbar styles */
      .toolbar {
        display: flex;
        justify-content: space-between;
        padding: 6px 12px;
        border-bottom: 1px solid var(--border-color);
      }

      .toolbar-buttons {
        display: flex;
        gap: 8px;
      }

      #new-collection-btn,
      #import-btn,
      #settings-btn {
        background-color: #f0f0f0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 6px 12px;
        color: var(--text-color);
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      #new-collection-btn:hover,
      #import-btn:hover,
      #settings-btn:hover {
        background-color: #e8e8e8;
        border-color: #d0d0d0;
      }

      [data-theme="dark"] #new-collection-btn,
      [data-theme="dark"] #import-btn,
      [data-theme="dark"] #settings-btn {
        background-color: #3a3a3c;
        border: transparent;
        border-radius: 4px;
        padding: 6px 12px;
        color: #ffffff;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      [data-theme="dark"] #new-collection-btn:hover,
      [data-theme="dark"] #import-btn:hover,
      [data-theme="dark"] #settings-btn:hover {
        background-color: #4a4a4c;
        border-color: #666;
      }

      .collection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 4px 8px; /* Increased padding from 2px to 4px to add more space */
        border-radius: 2px;
        margin-bottom: 0;
        transition: background-color 0.2s ease;
        border-bottom: 0px solid rgba(0, 0, 0, 0.1);
      }
      .drag-handle {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 6px;
        cursor: move;
        opacity: 0.4;
        transition: opacity 0.2s ease;
        align-self: center; /* Ensure vertical centering within flex parent */
      }

      .drag-handle:hover {
        background-color: var(--hover-color);
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }

      .collection-header:hover .drag-handle {
        opacity: 0.8;
      }

      .collection-name {
        margin-left: 4px;
        flex: 1;
      }

      .collection-header.dragging {
        opacity: 0.6;
        background-color: var(--figma-color-bg-hover);
      }

      .collection-header.drag-over {
        border-top: 2px solid var(--figma-color-border-brand);
      }

      .active-collection .collection-header {
        background-color: var(--hover-color);
        color: var(--text-color);
      }

      .active-collection .collection-header .delete-collection-btn,
      .active-collection .collection-header .share-collection-btn,
      .active-collection .collection-header .drag-handle {
        opacity: 100%;
        visibility: visible;
      }

      /* Add header right container for buttons and arrow */
      .collection-header-right {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .collection-name {
        display: flex;
        align-items: center;
        font-weight: 500;
        flex-grow: 1; /* Take up available space */
      }

      .collection-header:hover {
        background-color: var(--hover-color);
      }

      /* Style for collection actions */
      .collection-actions {
        display: flex;
        gap: 8px;
        transition: opacity 0.2s ease;
      }

      /* Make buttons more visible by default */
      .delete-collection-btn,
      .share-collection-btn,
      .drag-handle {
        opacity: 60% !important; /* Higher default opacity */
      }

      /* Full opacity on hover or active collection */
      .delete-collection-btn:hover,
      .share-collection-btn:hover,
      .drag-handle:hover,
      .collection-header:hover .delete-collection-btn,
      .collection-header:hover .share-collection-btn,
      .collection-header:hover .drag-handle,
      .active-collection .collection-header .delete-collection-btn,
      .active-collection .collection-header .share-collection-btn,
      .active-collection .collection-header .drag-handle {
        opacity: 100% !important;
      }

      .collection-header .arrow {
        transition: none;
        margin-left: 4px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        font-weight: bold;
      }

      .collection-header .arrow:before {
        content: "▶";
        display: block;
        font-size: 8px; /* Smaller triangle */
        transform: scale(1); /* Remove scaling to make it smaller */
      }

      .collection-header .arrow:hover {
        color: var(--primary-color); /* Light up on hover */
      }

      .collection-header .arrow.expanded {
        transform: rotate(90deg);
      }

      .collection-dimensions {
        margin-left: auto;
        font-size: 9px;
        color: var(--secondary-color);
        margin-right: 8px;
      }

      .collection-content {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        visibility: hidden;
        transition: none;
        margin: 0;
        padding: 0;
        transform-origin: top;
      }

      /* Prevent favorites from visually re-expanding due to layout reflow */
      .collection-content[data-collection-id="favorites"] {
        transition: none !important;
      }

      .collection-content.expanded {
        max-height: none;
        opacity: 1;
        visibility: visible;
        transition: none;
        border-top: none;
      }

      .preset-card {
        display: grid;
        grid-template-columns: 36px minmax(0, 1fr) auto;
        padding: 1px 2px; /* Reduced padding for more compact UI */
        cursor: pointer;
        position: relative;
        align-items: center;
        transition: background-color 0.2s, transform 0.3s ease,
          opacity 0.3s ease;
        opacity: 1;
        transform: translateX(0);
        height: auto;
        overflow: hidden;
        border: none;
        column-gap: 0px;
      }

      /* Create animation classes for entry/exit */
      .preset-card-removing {
        opacity: 0;
        transform: translateX(-20px);
        height: 0;
        padding: 0;
        margin: 0;
        border: none;
      }

      /* Add animation for child items when expanding */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-3px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .collection-content.expanded .preset-card {
        animation: none;
      }

      /* Remove animation for child items when expanding */
      .collection-content.expanded .preset-card:nth-child(1),
      .collection-content.expanded .preset-card:nth-child(2),
      .collection-content.expanded .preset-card:nth-child(3),
      .collection-content.expanded .preset-card:nth-child(4),
      .collection-content.expanded .preset-card:nth-child(5),
      .collection-content.expanded .preset-card:nth-child(n + 6) {
        animation-delay: 0ms;
      }

      /* Enhance hover effect */
      .preset-card:hover {
        background-color: var(--hover-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* Make delete button more visible on hover */
      .preset-card .delete-preset-btn {
        opacity: 40% !important;
      }

      .preset-card:hover .delete-preset-btn {
        opacity: 80% !important;
      }

      /* Make frame preview containers completely invisible in both dark and light mode */
      .preset-preview {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        position: relative;
        flex-shrink: 0;
        background-color: transparent !important;
        padding: 0;
        margin: 0;
        border: none;
        box-shadow: none;
        overflow: visible;
      }

      .preset-preview svg {
        background: transparent;
        overflow: visible;
      }

      /* Light theme frame colors - exact match to Figma screenshots */
      .frame-rect-fill {
        fill: #ececec;
        stroke: #c7c7c7;
        stroke-width: 1px;
      }

      /* Dark theme frame colors - exact match to Figma screenshots */
      [data-theme="dark"] .frame-rect-fill {
        fill: #474747;
        stroke: #5e5e5e;
        stroke-width: 1px;
      }

      .frame-visual {
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 3px;
        /* Visual size is dynamic based on aspect ratio but contained in fixed width parent */
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }

      /* Dark mode adjustments for better readability */
      [data-theme="dark"] .frame-visual {
        border: 1px solid #555;
        background-color: #2a2a2a;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      [data-theme="dark"] .preset-name,
      [data-theme="dark"] .preset-dimensions {
        color: rgba(255, 255, 255, 0.9);
      }

      [data-theme="dark"] .preset-card:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }

      [data-theme="dark"] .collection-header {
        background-color: #252526;
        border-bottom: 1px solid #000000;
      }

      [data-theme="dark"] .active-collection .collection-header {
        background-color: #4f4e4e;
      }

      [data-theme="dark"] .collection-name {
        color: #f5f5f5;
      }

      [data-theme="dark"] button {
        color: #eeeeee;
      }

      [data-theme="dark"] button:hover {
        background-color: transparent;
        box-shadow: none;
      }

      [data-theme="dark"] .favorite-btn.active svg {
        fill: #ffcc33;
        stroke: #ffcc33;
      }

      [data-theme="dark"] .new-collection-btn,
      [data-theme="dark"] .import-btn {
        background-color: #3a3a3c;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 6px 12px;
        color: #ffffff;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      [data-theme="dark"] .new-collection-btn:hover,
      [data-theme="dark"] .import-btn:hover {
        background-color: #4a4a4c;
        border-color: #666;
      }

      .preset-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90px; /* Fixed max width instead of percentage */
        margin-left: 4px; /* Reduced left margin */
      }

      .preset-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        overflow: hidden;
        min-width: 0; /* Important for text truncation to work properly */
      }

      .preset-dimensions-row {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 6px;
        margin-left: auto;
        flex-shrink: 0;
      }

      .preset-dimensions {
        font-size: 10px;
        color: var(--text-secondary);
      }

      .preset-actions {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2px;
        margin-left: 2px;
        opacity: 1;
      }

      .favorite-btn,
      .delete-preset-btn,
      .preset-actions button {
        border: none;
        background: none;
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.1s ease;
        width: 25px;
        height: 25px;
        position: relative;
        margin-right: 1px;
      }

      /* Make delete preset button more visible */
      .delete-preset-btn {
        opacity: 60% !important;
        color: var(--secondary-color);
        transition: all 0.2s ease;
      }

      .delete-preset-btn:hover,
      .preset-card:hover .delete-preset-btn {
        opacity: 100% !important;
        color: var(--error-color);
        background-color: rgba(255, 59, 48, 0.1);
      }

      .collection-actions button {
        border: none;
        background: none;
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 25px;
        height: 25px;
        position: relative;
        margin-right: 3px;
      }

      .preset-actions button svg,
      .collection-actions button svg {
        width: 16px;
        height: 16px;
      }

      .favorite-btn {
        color: #ffcc33;
        padding: 0;
        margin: 0 4px;
        border-radius: 0;
        background: none;
        box-shadow: none;
        min-width: auto;
        min-height: auto;
        width: 17px;
        height: 17px;
        flex-shrink: 0;
        opacity: 0.1 !important;
        transition: opacity 0.01s ease;
        z-index: 1;
        position: relative;
      }

      .favorite-btn.active {
        opacity: 1 !important;
        color: #ffcc33;
        background: none;
        box-shadow: none;
      }

      .favorite-btn svg {
        stroke: currentColor;
        stroke-width: 1.5px;
      }

      /* Light up ONLY when hovering over the star itself */
      .favorite-btn:hover {
        background-color: transparent;
        opacity: 1 !important;
      }

      /* Explicitly override any parent hover effects */
      .preset-card:hover .favorite-btn:not(:hover):not(.active) {
        opacity: 0.1 !important;
      }

      .preset-card:hover {
        background-color: var(--hover-color);
      }

      .preset-preview {
        background-color: var(--active-color);
        border-radius: 2px;
        margin-bottom: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 6px;
        aspect-ratio: 16/9;
        overflow: hidden;
        margin-left: 4px;
      }

      .frame-visual {
        margin-bottom: 4px;
        box-shadow: 0 1px 3px var(--shadow-color);
      }

      .frame-dimensions {
        font-size: 9px;
        color: var(--text-primary);
        text-align: center;
      }

      .preset-info {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        margin-left: 6px;
        width: 100%;
      }

      .preset-dimensions {
        font-size: 9px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 9px;
        flex: 1;
      }

      .favorite-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .preset-card:hover .favorite-btn {
        opacity: 1;
      }

      .favorite-btn.active {
        opacity: 1;
        color: var(--star-color);
      }

      /* Center the support creator button in the status bar */
      .status-bar {
        border-top: 0.3px solid var(--border-color);
        padding: 8px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        gap: 16px;
      }
      .status-bar-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .help-button {
        margin-right: 16px;
      }
      .theme-toggle {
        margin-left: auto;
      }
      #bmc-button {
        display: flex;
        align-items: center;
        gap: 4px;
        background-color: transparent;
        padding: 4px 12px;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-weight: 500;
        font-size: 20px;
        box-shadow: none;
        border: none;
        margin-left: 15px;
      }
      #bmc-button:hover {
        background-color: var(--hover-color);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px var(--shadow-color);
      }
      .bmc-emoji {
        font-size: 14px;
        margin-right: 4px;
      }

      /* Settings modal improvements */
      .modal-content {
        background-color: var(--bg-color);
        border-radius: 8px;
        padding: 0;
        width: 90%;
        max-width: 340px;
        box-shadow: 0 8px 24px var(--shadow-color);
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: 18px 20px 12px 20px;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        color: var(--heading-color);
        background: var(--bg-color);
      }
      .modal-body {
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        background: var(--bg-color);
      }
      .settings-section {
        margin-bottom: 14px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .settings-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .settings-section h3 {
        font-size: 13px;
        margin-bottom: 6px;
        color: var(--heading-color);
        font-weight: 600;
        text-align: left;
      }
      .settings-btn {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        border-radius: 5px;
        background-color: var(--hover-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        cursor: pointer;
        margin-bottom: 8px;
        width: 100%;
        justify-content: flex-start;
        font-size: 12px;
        font-weight: 500;
        transition: background 0.2s, border 0.2s;
      }
      .settings-btn svg {
        margin-right: 8px;
      }
      .settings-btn.danger {
        color: var(--error-color);
        border-color: var(--error-color);
        background: rgba(255, 59, 48, 0.05);
      }
      .settings-btn:hover {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
      }
      .settings-warning {
        font-size: 11px;
        color: var(--error-color);
        margin-top: 4px;
        margin-bottom: 0;
      }
      .about-info {
        padding: 4px 0 0 0;
      }
      .about-info p {
        margin-bottom: 8px;
        font-size: 12px;
        color: var(--text-color);
      }
      .settings-description {
        color: var(--secondary-color);
        font-size: 12px;
        margin-top: 8px;
        margin-bottom: 0;
        text-align: left;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 0;
        padding: 12px 20px;
        border-top: 1px solid var(--border-color);
        background-color: var(--active-color);
      }
      [data-theme="dark"] .modal-content,
      [data-theme="dark"] .modal-header,
      [data-theme="dark"] .modal-body {
        background: #232324;
        color: #eee;
      }
      [data-theme="dark"] .settings-section {
        border-color: #333;
      }
      [data-theme="dark"] .settings-btn {
        background-color: #2c2c2e;
        color: #eee;
        border-color: #38383a;
      }
      [data-theme="dark"] .settings-btn.danger {
        background: rgba(255, 59, 48, 0.08);
        color: #ff4530;
        border-color: #ff4530;
      }
      [data-theme="dark"] .settings-btn:hover {
        background-color: #0a84ff;
        color: #fff;
        border-color: #0a84ff;
      }
      [data-theme="dark"] .form-actions {
        background-color: #2a2a2c;
      }

      .help-button {
        cursor: pointer;
        color: var(--figma-secondary);
        padding: 4px;
        transition: color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .help-button:hover {
        color: var(--primary-color);
      }

      .help-text {
        font-size: 11px;
        font-weight: 500;
      }

      .theme-toggle {
        cursor: pointer;
        color: var(--figma-secondary);
        padding: 4px;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        backdrop-filter: blur(2px);
      }

      .modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background-color: var(--bg-color);
        border-radius: 6px;
        padding: 0;
        width: 90%;
        max-width: 320px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: translateY(10px);
        transition: transform 0.2s ease;
      }

      .modal.active .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        padding: 16px;
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
      }

      .modal-body {
        padding: 16px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .modal-icon {
        display: flex;
        justify-content: center;
        margin-bottom: 16px;
      }

      .modal-icon svg {
        opacity: 0.9;
      }

      .modal-description {
        text-align: center;
        margin-bottom: 12px;
        font-size: 11px;
        color: var(--text-color);
      }

      #preset-frames-container {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 4px;
        width: 100%;
      }

      .form-group {
        width: 100%;
      }

      .input-hint {
        font-size: 11px;
        color: var(--secondary-color);
        margin-top: 8px;
        line-height: 1.4;
        text-align: center;
      }

      [data-theme="dark"] .input-hint {
        color: var(--text-secondary);
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 0;
        padding: 12px 16px;
        border-top: 1px solid var(--border-color);
        background-color: var(--active-color);
      }

      [data-theme="dark"] .form-actions {
        background-color: #2a2a2c;
      }

      .favorites-section {
        border-bottom: 1px solid var(--border-color);
        max-height: 30vh;
        overflow-y: auto;
      }

      .empty-state {
        padding: 20px;
        text-align: center;
        color: var(--secondary-color);
        font-size: 12px;
      }

      .share-modal .share-link {
        background-color: var(--active-color);
        padding: 12px;
        border-radius: 4px;
        font-family: monospace;
        margin: 10px 0;
        word-break: break-all;
        text-align: center;
        font-size: 16px;
        letter-spacing: 1px;
        width: 100%;
        font-weight: 500;
      }

      .copy-btn {
        margin-top: 8px;
        justify-content: center;
        width: auto;
        flex-grow: 1;
        padding: 12px 16px;
        font-size: 13px;
        font-weight: 500;
        height: auto;
        min-height: 44px;
      }

      /* Form inputs styling */
      input[type="text"],
      input[type="number"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 12px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        margin-top: 4px;
      }

      input[type="text"]:focus,
      input[type="number"]:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(13, 153, 255, 0.15);
        outline: none;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        font-size: 11px;
        color: var(--text-color);
      }

      /* Loading animation */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
      }

      .loading-spinner {
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none !important;
      }

      /* Figma-style notification system */
      .notification {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        z-index: 2000;
        max-width: 90%;
        text-align: center;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }

      .notification.show {
        opacity: 1;
        pointer-events: all;
      }

      .notification-icon {
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification-error {
        background-color: #f5f5f5;
        color: #333333;
        border-left: 3px solid #f24822;
      }

      .notification-success {
        background-color: #f5f5f5;
        color: #333333;
        border-left: 3px solid #14ae5c;
      }

      .notification-warning {
        background-color: #f5f5f5;
        color: #333333;
        border-left: 3px solid #ffbd44;
      }

      /* Dark mode notifications */
      [data-theme="dark"] .notification {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      [data-theme="dark"] .notification-error,
      [data-theme="dark"] .notification-success,
      [data-theme="dark"] .notification-warning {
        background-color: #2c2c2e;
        color: #ffffff;
      }

      .frame-input-group {
        background-color: var(--bg-color);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
      }

      .frame-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 11px;
        color: var(--secondary-color);
      }

      .frame-input-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 2px;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 11px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        outline: none;
      }

      .frame-input-group input:focus {
        border-color: var(--figma-blue);
        box-shadow: 0 0 0 1px var(--figma-blue);
      }

      .frame-dimensions-row {
        display: flex;
        gap: 6px;
      }

      .dimension-group {
        position: relative;
        flex: 1;
        margin-right: 2px;
      }

      .dimension-group input {
        padding-right: 24px;
      }

      .dimension-group label {
        position: absolute;
        right: 8px;
        top: 8px;
        color: var(--secondary-color);
        font-size: 10px;
        pointer-events: none;
      }

      .frame-preview {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 0;
      }

      .frame-preview-visual {
        border: 1px solid var(--border-color);
        background-color: #fff;
        border-radius: 2px;
        position: relative;
      }

      [data-theme="dark"] .frame-preview-visual {
        background-color: #333;
        border-color: #444;
      }

      #preset-frames-container {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 4px;
      }

      .input-hint {
        font-size: 11px;
        color: var(--secondary-color);
        margin-top: 4px;
      }

      .collection {
        border-bottom: 1px solid var(--border-color);
        border-top: none;
        margin: 0;
        padding: 0;
      }

      /* Remove the last border to avoid double borders */
      .collection:last-child {
        border-bottom: none;
      }

      .collections-container {
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        width: 100%;
        /* Ensure no gaps between collections */
        gap: 0;
      }

      .collection-favorites .preset-dimensions {
        padding-right: 8px;
      }

      /* Remove bottom slider */
      body {
        overflow-x: hidden; /* Prevent horizontal scrolling */
        overflow-y: auto; /* Allow vertical scrolling */
        overscroll-behavior-x: none; /* Prevent horizontal overscroll */
      }

      /* Hide horizontal scrollbar */
      ::-webkit-scrollbar-horizontal {
        display: none;
      }

      /* Make delete button more visible in favorites section */
      .collection-favorites .preset-card .delete-preset-btn {
        opacity: 60% !important;
      }

      .collection-favorites .preset-card:hover .delete-preset-btn {
        opacity: 100% !important;
      }

      /* Settings modal styles */
      .settings-section {
        margin-bottom: 14px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }

      .settings-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .settings-section h3 {
        font-size: 12px;
        margin-bottom: 12px;
        color: var(--text-color);
      }

      .settings-btn {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 4px;
        background-color: var(--button-color);
        color: var(--text-color);
        border: none;
        cursor: pointer;
        margin-bottom: 8px;
        width: 100%;
        justify-content: flex-start;
      }

      .settings-btn svg {
        margin-right: 8px;
      }

      .settings-btn.danger {
        color: var(--error-color);
      }

      .settings-btn:hover {
        background-color: var(--hover-color);
      }

      .settings-warning {
        font-size: 10px;
        color: var(--error-color);
        margin-top: 4px;
      }

      .about-info {
        padding: 8px 0;
      }

      .about-info p {
        margin-bottom: 8px;
        font-size: 11px;
      }

      .settings-description {
        color: var(--secondary-color);
        font-size: 10px;
      }

      /* Inline Name Edit Modal */
      .frame-dimensions-info {
        margin-top: 12px;
        color: var(--secondary-color);
        font-size: 11px;
        text-align: center;
        padding: 8px;
        background-color: var(--hover-color);
        border-radius: 4px;
      }

      /* Loading spinner */
      .loading-spinner {
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      /* Help Modal Styles */
      .help-modal-body {
        padding: 16px;
        max-height: 65vh;
        overflow-y: auto;
      }

      .help-section {
        margin-bottom: 20px;
        padding: 16px;
        background: var(--bg-color);
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-color);
      }

      .help-section h3 {
        color: var(--heading-color);
        font-size: 14px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Feature grid */
      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .feature-card {
        padding: 12px;
        background: var(--hover-color);
        border-radius: 8px;
        transition: all 0.2s ease;
        height: 100px;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        border: 1px solid var(--border-color);
      }

      .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
        border-color: var(--primary-color);
      }

      .feature-icon {
        font-size: 20px;
        margin-bottom: 8px;
        transition: transform 0.2s ease;
      }

      .feature-card:hover .feature-icon {
        transform: scale(1.1);
      }

      .feature-card strong {
        display: block;
        margin-bottom: 4px;
        color: var(--heading-color);
        font-size: 12px;
      }

      .feature-card p {
        margin: 0;
        color: var(--text-color);
        font-size: 11px;
        line-height: 1.4;
      }

      /* Need Help Section */
      .need-help-container {
        background: linear-gradient(
          to right,
          var(--hover-color),
          var(--bg-color)
        );
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .help-tips-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }

      .help-tip-card {
        background: var(--bg-color);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
      }

      .help-tip-card:hover {
        border-color: var(--primary-color);
        transform: translateX(4px);
      }

      .help-tip-card h4 {
        font-size: 12px;
        color: var(--heading-color);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .help-tip-card .help-list {
        margin: 0;
      }

      .help-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .help-list li {
        margin-bottom: 8px;
        padding-left: 20px;
        position: relative;
        color: var(--text-color);
        font-size: 11px;
        line-height: 1.5;
      }

      .help-list li:before {
        content: "→";
        position: absolute;
        left: 0;
        color: var(--primary-color);
      }

      .help-list li:last-child {
        margin-bottom: 0;
      }

      /* Keyboard shortcuts */
      .shortcuts-container {
        background: var(--bg-color);
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
      }

      .shortcuts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 8px;
      }

      .shortcut-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px;
        border-radius: 6px;
        transition: background-color 0.2s ease;
      }

      .shortcut-item:hover {
        background-color: var(--hover-color);
      }

      .keyboard-shortcut {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .keyboard-key {
        background: var(--hover-color);
        padding: 3px 6px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        font-family: monospace;
        font-size: 11px;
        min-width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px var(--shadow-color);
      }

      .premium-bundle-link {
        padding: 8px 16px;
        background-color: transparent;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 8px;
        margin-bottom: 8px;
        position: relative;
        z-index: 5;
        box-shadow: none;
      }

      .premium-bundle-link:hover {
        background-color: rgba(95, 127, 255, 0.1);
        transform: none;
        box-shadow: none;
      }

      .premium-bundle-link a {
        color: var(--text-color);
        text-decoration: none;
        font-size: 10px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0;
        line-height: 1.4;
      }

      .premium-bundle-link .premium-icon {
        margin-right: 6px;
        color: var(--text-color);
        font-size: 10px;
        text-shadow: none;
      }

      .premium-bundle-link:hover .premium-icon {
        color: gold;
      }

      .step-number {
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
      }

      .step-content {
        flex: 1;
      }

      .step-content strong {
        display: block;
        margin-bottom: 5px;
        color: var(--heading-color);
        font-size: 12px;
      }

      .step-content p {
        margin: 0;
        color: var(--text-color);
        line-height: 1.4;
        font-size: 11px;
        margin-top: 4px;
      }

      /* Support section styles */
      .support-section {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--accent-color) 100%
        );
        color: white;
      }

      .support-section h3 {
        color: white;
      }

      .support-content {
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
      }

      .support-content p {
        margin-bottom: 15px;
      }

      .support-email {
        color: white;
        text-decoration: underline;
        font-weight: 500;
      }

      .support-email:hover {
        color: var(--star-color);
      }

      /* UI reference styles */
      .ui-reference {
        display: inline-block;
        padding: 2px 6px;
        background: var(--primary-color);
        color: white;
        border-radius: 4px;
        font-size: 10px;
        margin: 0 2px;
      }

      /* Keyboard shortcut styles */
      kbd {
        display: inline-block;
        padding: 2px 6px;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        color: var(--text-color);
        box-shadow: 0 1px 1px var(--shadow-color);
      }

      /* Dark mode adjustments */
      [data-theme="dark"] .step,
      [data-theme="dark"] .feature-card,
      [data-theme="dark"] .tip {
        background: var(--hover-color);
      }

      [data-theme="dark"] .support-section {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--accent-color) 100%
        );
      }

      [data-theme="dark"] kbd {
        background: var(--bg-color);
        border-color: var(--border-color);
      }

      /* Quick Start Guide Styles */
      .quick-start-section {
        background: transparent;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px var(--shadow-color);
      }

      .step-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .step {
        background: var(--bg-color);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        gap: 3px;
        align-items: flex-start;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
        height: 100px;
        margin-right: 3px;
      }

      .step::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: var(--primary-color);
        opacity: 0.5;
      }

      .step:hover {
        border-color: var(--primary-color);
        transform: translateX(3px);
      }

      .step:hover::before {
        opacity: 1;
      }

      .step-number {
        background: var(--primary-color);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 10px;
        flex-shrink: 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .step-content {
        flex: 1;
      }

      .step-content strong {
        display: block;
        color: var(--heading-color);
        font-size: 13px;
        margin-bottom: 4px;
      }

      .step-content p {
        color: var(--text-color);
        font-size: 11px;
        line-height: 1.4;
        margin: 0;
      }

      /* Tips container styles */
      .tips-container {
        background: transparent;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid var(--border-color);
        margin-top: 12px;
      }

      /* Support section styles */
      .support-section {
        border-radius: 8px;
        background-color: transparent;
        padding: 16px;
        border: 1px solid var(--border-color);
        margin-top: 12px;
        box-shadow: 0 1px 3px var(--shadow-color);
      }

      .support-section h3 {
        margin-bottom: 12px;
      }

      .support-content {
        margin: 0;
        background-color: transparent;
      }

      .support-content p {
        margin-bottom: 12px;
        color: var(--text-color);
        font-size: 11px;
        line-height: 1.5;
        text-align: center;
      }

      .support-email {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
      }

      .support-email:hover {
        color: var(--primary-color);
        text-decoration: underline;
      }

      /* Improve help list styles for better hierarchy */
      .help-list li {
        position: relative;
        padding-left: 20px;
        margin-bottom: 8px;
        line-height: 1.5;
        color: var(--text-color);
        font-size: 11px;
      }

      .help-list li:before {
        content: "•";
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-weight: bold;
      }

      /* Dark mode improvements */
      [data-theme="dark"] .support-section {
        background: transparent;
        border-color: rgba(13, 153, 255, 0.3);
      }

      [data-theme="dark"] .tips-container {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.1);
      }

      /* Favorite Button Styles */
      .favorite-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: color 0.2s ease;
        color: var(--text-secondary);
      }

      .favorite-btn.active {
        color: var(--star-color);
      }

      /* Light mode specific styles */
      [data-theme="light"] .favorite-btn {
        color: rgba(0, 0, 0, 0.3);
      }

      [data-theme="light"] .favorite-btn:hover {
        color: var(--star-color);
      }

      [data-theme="dark"] button.primary {
        background-color: var(--primary-color);
        color: white;
        border: none;
      }

      [data-theme="dark"] button.primary:hover {
        background-color: #1a90ff; /* Slightly lighter blue */
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Fix toolbar buttons in dark mode */
      [data-theme="dark"] #new-collection-btn,
      [data-theme="dark"] #import-btn,
      [data-theme="dark"] #settings-btn {
        background-color: #3a3a3c;
        border: transparent;
        border-radius: 4px;
        padding: 6px 12px;
        color: #ffffff;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      [data-theme="dark"] #new-collection-btn:hover,
      [data-theme="dark"] #import-btn:hover,
      [data-theme="dark"] #settings-btn:hover {
        background-color: #4a4a4c;
        border-color: #666;
      }

      /* Toolbar button containers for light mode */
      #new-collection-btn,
      #import-btn,
      #settings-btn {
        background-color: #f0f0f0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 6px 12px;
        color: var(--text-color);
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      #new-collection-btn:hover,
      #import-btn:hover,
      #settings-btn:hover {
        background-color: #e8e8e8;
        border-color: #d0d0d0;
      }

      /* Fix spacing for support creator button */
      #bmc-button {
        margin-left: 10px;
        gap: 4px;
        background-color: transparent;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      #bmc-button:hover {
        background-color: var(--hover-color);
        transform: translateY(-1px);
      }

      .bmc-emoji {
        font-size: 12px;
        margin-right: 2px;
      }

      /* Fix toolbar spacing */
      .toolbar-buttons {
        display: flex;
        gap: 8px;
      }

      /* Style Help section like Quick Start */
      .help-section.support-section {
        background: linear-gradient(
          135deg,
          var(--hover-color) 0%,
          var(--bg-color) 100%
        );
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px var(--shadow-color);
      }

      .help-section.support-section h3 {
        color: var(--heading-color);
        margin-bottom: 12px;
        font-weight: 600;
      }

      .support-content {
        background-color: var(--bg-color);
        border-radius: 8px;
        padding: 16px;
        border: 1px solid var(--border-color);
      }

      .support-content .help-list {
        margin-top: 12px;
      }

      .support-content .help-list li {
        position: relative;
        padding-left: 20px;
        margin-bottom: 8px;
        line-height: 1.5;
      }

      .support-content .help-list li:before {
        content: "•";
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-weight: bold;
      }

      /* Test Connection button fix for light mode */
      #check-connection-btn.settings-btn {
        background-color: var(--hover-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        font-weight: 500;
        font-size: 12px;
        transition: background 0.2s, border 0.2s;
        width: 100%;
        margin-top: 2px;
        margin-bottom: 0;
        align-self: stretch;
      }
      #check-connection-btn.settings-btn:hover {
        background-color: #e0f2ff;
        color: var(--primary-color);
        border-color: var(--primary-color);
      }
      [data-theme="dark"] #check-connection-btn.settings-btn {
        background-color: #2c2c2e;
        color: #eee;
        border-color: #38383a;
      }
      [data-theme="dark"] #check-connection-btn.settings-btn:hover {
        background-color: #0a84ff;
        color: #fff;
        border-color: #0a84ff;
      }
      .settings-btn.danger:hover {
        background-color: #b2001a !important;
        color: #fff !important;
        border-color: #b2001a !important;
      }

      #bmc-button {
        font-size: 11px;
        margin-left: 8px;
      }

      #new-collection-btn,
      #import-btn,
      #settings-btn,
      button,
      .settings-btn,
      .form-actions button,
      #bmc-button {
        border-radius: 4px !important;
      }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body data-theme="dark">
    <div class="sidebar">
      <div class="header">
        <h3>v1.0</h3>
        <div>
          <button
            id="create-preset-btn"
            class="primary"
            data-tooltip="Save selected frame to active collection"
          >
            <svg
              width="12"
              height="12"
              viewBox="0 0 12 12"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6 1V11M1 6H11"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
              />
            </svg>
            Save Frame
          </button>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-buttons">
          <button
            id="new-collection-btn"
            data-tooltip="Create a new collection"
          >
            <svg
              width="12"
              height="12"
              viewBox="0 0 12 12"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6 1V11M1 6H11"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
              />
            </svg>
            New Collection
          </button>
          <button
            id="import-btn"
            data-tooltip="Import a collection from another user"
          >
            <svg
              width="12"
              height="12"
              viewBox="0 0 12 12"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M1 9L1 10C1 10.5523 1.44772 11 2 11L10 11C10.5523 11 11 10.5523 11 10L11 9M6 8L6 1M6 8L3.5 5.5M6 8L8.5 5.5"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Import
          </button>
          <button
            id="settings-btn"
            data-tooltip="Open plugin settings"
            style="margin-left: 8px"
          >
            <svg
              width="12"
              height="12"
              viewBox="0 0 12 12"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6 7.75C6.9665 7.75 7.75 6.9665 7.75 6C7.75 5.0335 6.9665 4.25 6 4.25C5.0335 4.25 4.25 5.0335 4.25 6C4.25 6.9665 5.0335 7.75 6 7.75Z"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M9.5 6C9.5 6.11 9.495 6.215 9.485 6.32L10.5 7.115C10.59 7.19 10.615 7.315 10.56 7.415L9.685 8.915C9.63 9.015 9.51 9.055 9.405 9.015L8.215 8.53C8.04 8.66 7.85 8.77 7.65 8.86L7.45 10.115C7.43 10.22 7.34 10.3 7.23 10.3H5.48C5.37 10.3 5.28 10.22 5.265 10.115L5.065 8.86C4.865 8.77 4.675 8.66 4.5 8.53L3.31 9.015C3.205 9.055 3.085 9.015 3.03 8.915L2.155 7.415C2.1 7.315 2.125 7.19 2.215 7.115L3.23 6.32C3.22 6.215 3.215 6.11 3.215 6C3.215 5.89 3.22 5.785 3.23 5.68L2.215 4.885C2.125 4.81 2.1 4.685 2.155 4.585L3.03 3.085C3.085 2.985 3.205 2.945 3.31 2.985L4.5 3.47C4.675 3.34 4.865 3.23 5.065 3.14L5.265 1.885C5.285 1.78 5.375 1.7 5.485 1.7H7.235C7.345 1.7 7.435 1.78 7.45 1.885L7.65 3.14C7.85 3.23 8.04 3.34 8.215 3.47L9.405 2.985C9.51 2.945 9.63 2.985 9.685 3.085L10.56 4.585C10.615 4.685 10.59 4.81 10.5 4.885L9.485 5.68C9.495 5.785 9.5 5.89 9.5 6Z"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Settings
          </button>
        </div>
      </div>

      <div class="collections-container">
        <!-- Collections will be added here dynamically -->
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>

        <div class="premium-bundle-link">
          <a href="#" id="premium-bundle-btn">
            <span class="premium-icon">✨</span>
            <strong>Get Premium Templates & Bundles</strong>
          </a>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-bar-left">
          <div class="help-button" id="help-button" data-tooltip="Help & Tips">
            <svg
              width="14"
              height="14"
              viewBox="0 0 14 14"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7 13C10.3137 13 13 10.3137 13 7C13 3.68629 10.3137 1 7 1C3.68629 1 1 3.68629 1 7C1 10.3137 3.68629 13 7 13Z"
                stroke="currentColor"
                stroke-width="1.5"
              />
              <path
                d="M7 10V10.01M7 4C5.89543 4 5 4.89543 5 6C5 7.10457 5.89543 8 7 8C8.10457 8 9 7.10457 9 6C9 4.89543 8.10457 4 7 4Z"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
              />
            </svg>
            <span class="help-text">Help</span>
          </div>

          <button id="bmc-button" class="bmc-custom-button">
            <span class="bmc-emoji">☕</span>
            Support creator
          </button>
        </div>
        <div
          class="theme-toggle"
          id="theme-toggle"
          data-tooltip="Dark/Light mode"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 14 14"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M7 1.5V1M7 13V12.5M12.5 7H13M1 7H1.5M10.8995 3.1005L11.2497 2.7503M2.7503 11.2497L3.1005 10.8995M10.8995 10.8995L11.2497 11.2497M2.7503 2.7503L3.1005 3.1005M9.5 7C9.5 8.38071 8.38071 9.5 7 9.5C5.61929 9.5 4.5 8.38071 4.5 7C4.5 5.61929 5.61929 4.5 7 4.5C8.38071 4.5 9.5 5.61929 9.5 7Z"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
            />
          </svg>
        </div>
      </div>
    </div>
    <!-- End of sidebar -->

    <!-- Create Collection Modal -->
    <div class="modal" id="new-collection-modal">
      <div class="modal-content">
        <div class="modal-header">Create New Collection</div>
        <div class="modal-body">
          <div class="form-group">
            <div class="modal-icon">
              <svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"
                  fill="var(--primary-color)"
                />
              </svg>
            </div>
            <label for="collection-name">Collection Name</label>
            <input
              type="text"
              id="collection-name"
              placeholder="e.g., Web Banners"
              autofocus
            />
            <div class="input-hint">
              Collections help you organize related frame presets together for
              easy access.
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button id="cancel-collection-btn">Cancel</button>
          <button id="save-collection-btn" class="primary">
            Create Collection
          </button>
        </div>
      </div>
    </div>

    <!-- Create Preset Modal -->
    <div class="modal" id="create-preset-modal">
      <div class="modal-content">
        <div class="modal-header">Save Frame Preset</div>
        <div class="modal-body">
          <div id="preset-frames-container">
            <!-- Frame inputs will be added here dynamically -->
          </div>
        </div>
        <div class="form-actions">
          <button id="cancel-preset-btn">Cancel</button>
          <button id="save-preset-btn" class="primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Share Collection Modal -->
    <div class="modal share-modal" id="share-collection-modal">
      <div class="modal-content">
        <div class="modal-header">Share Collection</div>
        <div class="modal-body">
          <div class="modal-icon">
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M18 16.08C17.24 16.08 16.56 16.38 16.04 16.85L8.91 12.7C8.96 12.47 9 12.24 9 12C9 11.76 8.96 11.53 8.91 11.3L15.96 7.19C16.5 7.69 17.21 8 18 8C19.66 8 21 6.66 21 5C21 3.34 19.66 2 18 2C16.34 2 15 3.34 15 5C15 5.24 15.04 5.47 15.09 5.7L8.04 9.81C7.5 9.31 6.79 9 6 9C4.34 9 3 10.34 3 12C3 13.66 4.34 15 6 15C6.79 15 7.5 14.69 8.04 14.19L15.16 18.35C15.11 18.56 15.08 18.78 15.08 19C15.08 20.61 16.39 21.92 18 21.92C19.61 21.92 20.92 20.61 20.92 19C20.92 17.39 19.61 16.08 18 16.08Z"
                fill="var(--primary-color)"
              />
            </svg>
          </div>
          <p class="modal-description">
            Share this code with others to let them import your collection:
          </p>
          <div class="share-link" id="share-link">...</div>
          <div class="input-hint">
            This shared collection will be available for 30 days. Anyone with
            this code can import your collection.
          </div>
        </div>
        <div class="form-actions">
          <button id="copy-share-link" class="copy-btn primary">
            Copy to Clipboard
          </button>
          <button id="close-share-modal-btn">Close</button>
        </div>
      </div>
    </div>

    <!-- Import Collection Modal -->
    <div class="modal" id="import-collection-modal">
      <div class="modal-content">
        <div class="modal-header">Import Collection</div>
        <div class="modal-body">
          <div class="modal-icon">
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M19 9H15V3H9V9H5L12 16L19 9ZM5 18V20H19V18H5Z"
                fill="var(--primary-color)"
              />
            </svg>
          </div>
          <div class="form-group">
            <label for="import-id">Collection Code</label>
            <input
              type="text"
              id="import-id"
              placeholder="Paste the 6-character code"
            />
            <div class="input-hint">
              <span
                >Paste the 6-character code shared with you to import a
                collection.</span
              ><br />
              <span
                style="
                  display: block;
                  margin-top: 6px;
                  color: var(--secondary-color);
                  font-size: 10px;
                "
              >
                To share a collection, use the Share button in the collection
                header.
              </span>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button id="cancel-import-btn">Cancel</button>
          <button id="import-collection-btn" class="primary">Import</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
      <div class="modal-content">
        <div class="modal-header">Settings</div>
        <div class="modal-body">
          <div class="modal-icon">
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 15.5C13.933 15.5 15.5 13.933 15.5 12C15.5 10.067 13.933 8.5 12 8.5C10.067 8.5 8.5 10.067 8.5 12C8.5 13.933 10.067 15.5 12 15.5Z"
                fill="var(--primary-color)"
              />
              <path
                d="M19.43 12.98C19.47 12.66 19.5 12.34 19.5 12C19.5 11.66 19.47 11.34 19.43 11.02L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.97 19.05 5.05L16.56 6.05C16.04 5.65 15.48 5.32 14.87 5.07L14.49 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.51 2.42L9.13 5.07C8.52 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.72 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11.02C4.53 11.34 4.5 11.67 4.5 12C4.5 12.33 4.53 12.66 4.57 12.98L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.95C7.96 18.35 8.52 18.68 9.13 18.93L9.51 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.49 21.58L14.87 18.93C15.48 18.68 16.04 18.34 16.56 17.95L19.05 18.95C19.28 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.98Z"
                fill="var(--primary-color)"
                fill-opacity="0.5"
              />
            </svg>
          </div>

          <div class="settings-section">
            <h3>Connection</h3>
            <button id="check-connection-btn" class="settings-btn">
              <svg
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.5 6C10.5 8.48528 8.48528 10.5 6 10.5C3.51472 10.5 1.5 8.48528 1.5 6C1.5 3.51472 3.51472 1.5 6 1.5C8.48528 1.5 10.5 3.51472 10.5 6Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
                <path
                  d="M4 6L5.25 7.25L8 4.5"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Test Connection
            </button>
            <div class="settings-description">
              Test connection with database if you encounter any error in share
              feature.
            </div>
          </div>

          <div class="settings-section">
            <h3>Data Management</h3>
            <button id="reset-plugin-btn" class="settings-btn danger">
              <svg
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M6 10.5C8.48528 10.5 10.5 8.48528 10.5 6C10.5 3.51472 8.48528 1.5 6 1.5C3.51472 1.5 1.5 3.51472 1.5 6C1.5 8.48528 3.51472 10.5 6 10.5Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
                <path
                  d="M3.75 6H8.25"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Reset to Default
            </button>
            <p class="settings-warning">
              This will delete all your custom collections and restore the
              default ones.
            </p>
          </div>

          <div class="settings-section">
            <h3>About</h3>
            <div class="about-info">
              <p><strong>SaveFrame</strong> v1.0.0</p>
              <p class="settings-description">
                A Figma plugin to save and reuse frame presets.
              </p>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button id="close-settings-btn" class="primary">Close</button>
        </div>
      </div>
    </div>

    <!-- Inline Name Edit Modal -->
    <div class="modal" id="inline-name-edit-modal">
      <div class="modal-content">
        <div class="modal-header">Save Frame</div>
        <div class="modal-body">
          <div class="modal-icon">
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M19 21H5C3.9 21 3 20.1 3 19V5C3 3.9 3.9 3 5 3H19C20.1 3 21 3.9 21 5V19C21 20.1 20.1 21 19 21Z"
                fill="var(--primary-color)"
                fill-opacity="0.5"
              />
              <path d="M14 15H10V19H14V15Z" fill="var(--primary-color)" />
              <path d="M8 11H16V13H8V11Z" fill="var(--primary-color)" />
              <path d="M8 7H16V9H8V7Z" fill="var(--primary-color)" />
            </svg>
          </div>
          <div class="form-group">
            <label for="inline-frame-name">Frame Name</label>
            <input
              type="text"
              id="inline-frame-name"
              placeholder="Enter frame name"
              autofocus
            />
            <div class="frame-dimensions-info" id="frame-dimensions-info">
              <!-- Will be filled dynamically -->
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button id="cancel-inline-edit-btn">Cancel</button>
          <button id="save-inline-edit-btn" class="primary">Save Frame</button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="help-modal">
      <div class="modal-content">
        <div class="modal-header">Welcome to SaveFrame ! 🎨</div>
        <div class="modal-body help-modal-body">
          <div class="help-section">
            <h3>🚀 Quick Start Guide</h3>
            <div class="quick-start-section">
              <div class="step-container">
                <div class="step-number">1</div>
                <div class="step-content">
                  <strong>Create Collection</strong>
                  <p>
                    Start by creating a new collection to organize your frames.
                    Click the "New Collection" button to get started.
                  </p>
                </div>
                <div class="step-number">2</div>
                <div class="step-content">
                  <strong>Save Frames</strong>
                  <p>
                    Select any frame in Figma and click "Save Frame" to add it
                    to your active collection.
                  </p>
                </div>
                <div class="step-number">3</div>
                <div class="step-content">
                  <strong>Apply & Reuse</strong>
                  <p>
                    Click any saved frame to instantly apply its dimensions to
                    your selected frame in Figma.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="help-section">
            <h3>💡 Smart Features</h3>
            <div class="feature-grid">
              <div class="feature-card">
                <div class="feature-icon">⭐</div>
                <strong>Favorites</strong>
                <p>Star frames for quick access to your most-used presets</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">🔗</div>
                <strong>Share</strong>
                <p>Export and share frame collections with your team</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">👁️</div>
                <strong>Preview</strong>
                <p>Visual preview of frame dimensions and aspect ratios</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">🗂️</div>
                <strong>Collections</strong>
                <p>Organize related frames into collections</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">📱</div>
                <strong>Manage</strong>
                <p>Rename, delete, and organize your frames</p>
              </div>
              <div class="feature-card">
                <div class="feature-icon">🎨</div>
                <strong>Themes</strong>
                <p>Switch between light and dark mode</p>
              </div>
            </div>
          </div>

          <div class="help-section">
            <h3>⌨️ Pro Tips & Shortcuts</h3>
            <div class="tips-container">
              <strong>Keyboard Shortcuts:</strong>
              <ul class="help-list">
                <li><kbd>Enter</kbd> - Save when editing a frame name</li>
                <li><kbd>Esc</kbd> - Cancel or close any open modal</li>
              </ul>
            </div>
          </div>

          <div class="help-section">
            <h3>🗂️ Managing Your Frames & Collections</h3>
            <ul class="help-list">
              <li>
                <strong>Add to Favorites:</strong> Click the star icon next to
                any frame
              </li>
              <li>
                <strong>Rename Frames:</strong> Double-click on frame names to
                edit them
              </li>
              <li>
                <strong>Delete Frames:</strong> Click the trash icon next to any
                saved frame
              </li>
              <li>
                <strong>Share Collections:</strong> Use the share button in
                collection headers
              </li>
              <li>
                <strong>Import Collections:</strong> Use the "Import" button
                with shared codes
              </li>
              <li>
                <strong>Organize:</strong> Drag and drop frames between
                collections
              </li>
              <li>
                <strong>Collection Management:</strong> Use the collection menu
                for more options
              </li>
            </ul>
          </div>

          <div class="help-section support-section">
            <h3>🤝 Need Help?</h3>
            <div class="support-content">
              <p>We're here to help you make the most of SaveFrame !</p>
              <ul class="help-list">
                <li>
                  📧 Email us at:
                  <a
                    href="mailto:rahmanhabeeb360@gmail.com"
                    class="support-email"
                    >rahmanhabeeb360@gmail.com</a
                  >
                </li>
                <li>🌐 Visit our website for more resources and updates</li>
                <li>
                  ✨ Check out our premium frame bundles for additional
                  templates
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button id="close-help-btn" class="primary">Got it!</button>
        </div>
      </div>
    </div>

    <!-- Supabase Config Modal -->
    <div class="modal" id="supabase-config-modal">
      <div class="modal-content">
        <div class="modal-header">Supabase Configuration</div>
        <div class="modal-body">
          <div class="form-group">
            <label for="supabase-url">Supabase URL</label>
            <input
              type="text"
              id="supabase-url"
              placeholder="https://your-project.supabase.co"
            />
          </div>
          <div class="form-group">
            <label for="supabase-key">Supabase Anon Key</label>
            <input type="text" id="supabase-key" placeholder="your-anon-key" />
          </div>
        </div>
        <div class="form-actions">
          <button id="cancel-supabase-btn">Cancel</button>
          <button id="save-supabase-btn" class="primary">Save</button>
        </div>
      </div>
    </div>
    <script>
      // ============================================================
      // Global state
      // ============================================================
      let pluginData = {
        collections: [],
        activeCollectionId: null,
        lastSyncedAt: null,
      };

      let theme = "light";
      let supabaseConfig = {
        url: null,
        key: null,
      };

      // Supabase client initialization
      let supabaseClient = null;

      async function initSupabase(url, key) {
        try {
          // Check if we already have a client with the same URL and key
          if (supabaseClient) {
            // If the URL and key are the same, reuse the existing client
            if (
              supabaseClient.supabaseUrl === url &&
              supabaseClient.supabaseKey === key
            ) {
              console.log("Reusing existing Supabase client");
              return true;
            }

            // If different URL or key, log a message but don't create a new instance
            // to avoid the multiple GoTrueClient warning
            console.log(
              "Supabase client already exists with different credentials"
            );
            return true;
          }

          // Create a new client only if one doesn't exist yet
          supabaseClient = supabase.createClient(url, key, {
            auth: {
              autoRefreshToken: true,
              persistSession: false, // Don't persist session to avoid conflicts
              detectSessionInUrl: false, // Don't detect session in URL to avoid conflicts
            },
          });

          // Store the URL and key on the client for later comparison
          supabaseClient.supabaseUrl = url;
          supabaseClient.supabaseKey = key;

          return true;
        } catch (error) {
          console.error("Failed to initialize Supabase:", error);
          return false;
        }
      }

      // ============================================================
      // DOM Elements
      // ============================================================
      // Global variables
      const collectionsContainer = document.querySelector(
        ".collections-container"
      );
      const themeToggle = document.getElementById("theme-toggle");
      const syncBtn = document.getElementById("sync-btn");
      const createPresetBtn = document.getElementById("create-preset-btn");
      const newCollectionBtn = document.getElementById("new-collection-btn");
      const importBtn = document.getElementById("import-btn");
      const checkConnectionBtn = document.getElementById(
        "check-connection-btn"
      );

      // Modal elements
      const newCollectionModal = document.getElementById(
        "new-collection-modal"
      );
      const collectionNameInput = document.getElementById("collection-name");
      const saveCollectionBtn = document.getElementById("save-collection-btn");
      const cancelCollectionBtn = document.getElementById(
        "cancel-collection-btn"
      );

      const createPresetModal = document.getElementById("create-preset-modal");
      const presetFramesContainer = document.getElementById(
        "preset-frames-container"
      );
      const savePresetBtn = document.getElementById("save-preset-btn");
      const cancelPresetBtn = document.getElementById("cancel-preset-btn");

      const shareCollectionModal = document.getElementById(
        "share-collection-modal"
      );
      const shareLink = document.getElementById("share-link");
      const copyShareLinkBtn = document.getElementById("copy-share-link");
      const closeShareModalBtn = document.getElementById(
        "close-share-modal-btn"
      );

      const importCollectionModal = document.getElementById(
        "import-collection-modal"
      );
      const importIdInput = document.getElementById("import-id");
      const importCollectionBtn = document.getElementById(
        "import-collection-btn"
      );
      const cancelImportBtn = document.getElementById("cancel-import-btn");

      const supabaseConfigModal = document.getElementById(
        "supabase-config-modal"
      );
      const supabaseUrlInput = document.getElementById("supabase-url");
      const supabaseKeyInput = document.getElementById("supabase-key");
      const saveSupabaseBtn = document.getElementById("save-supabase-btn");
      const cancelSupabaseBtn = document.getElementById("cancel-supabase-btn");

      // ============================================================
      // Helper Functions
      // ============================================================

      // Show a modal
      function showModal(modal) {
        modal.classList.add("active");

        // Auto-focus on input fields if they exist
        setTimeout(() => {
          const input = modal.querySelector("input[autofocus]");
          if (input) {
            input.focus();
          }
        }, 100);
      }

      // Hide a modal
      function hideModal(modal) {
        modal.classList.remove("active");
      }

      // Generate a unique ID
      function generateId() {
        return Date.now().toString();
      }

      // Toggle collection expansion
      function toggleCollection(collectionId) {
        const arrow = document.querySelector(
          `.collection-${collectionId} .arrow`
        );
        const content = document.querySelector(
          `.collection-content[data-collection-id="${collectionId}"]`
        );

        arrow.classList.toggle("expanded");
        content.classList.toggle("expanded");
      }

      // Toggle theme
      function toggleTheme() {
        if (theme === "light") {
          document.body.setAttribute("data-theme", "dark");
          theme = "dark";
        } else {
          document.body.removeAttribute("data-theme");
          theme = "light";
        }

        // Save theme preference
        parent.postMessage(
          { pluginMessage: { type: "theme-preference", theme } },
          "*"
        );
      }

      // Format dimensions for display
      function formatDimensions(width, height) {
        return `${Math.round(width)} × ${Math.round(height)}`;
      }

      // Calculate scale factor for frames to ensure consistent visual size
      function calculateScaleFactor(width, height) {
        const targetSize = 50; // Our target frame size (50x50px)
        const maxDimension = Math.max(width, height);

        // Scale down large frames
        if (maxDimension > targetSize) {
          return targetSize / maxDimension;
        }
        // Scale up small frames
        else if (maxDimension < targetSize) {
          return targetSize / maxDimension;
        }
        // Keep 1:1 if already at target size
        return 1;
      }

      // Supabase Integration
      async function setupSupabase() {
        if (!supabaseConfig.url || !supabaseConfig.key) {
          showModal(supabaseConfigModal);
          return false;
        }
        return true;
      }

      // Create Supabase client
      function createSupabaseClient() {
        // This is a simplified version since we can't include the actual Supabase client library
        // In a real implementation, you would use the Supabase JS client
        return {
          from: (table) => {
            return {
              select: () => Promise.resolve([]),
              insert: (data) => Promise.resolve(data),
              update: (data) => Promise.resolve(data),
              delete: () => Promise.resolve(true),
              eq: () => this,
            };
          },
          auth: {
            getSession: () => Promise.resolve(null),
          },
        };
      }

      // Sync data to Supabase
      async function syncToSupabase() {
        try {
          // Initialize Supabase if needed
          if (!supabaseClient) {
            // Try to use saved config first
            if (supabaseConfig.url && supabaseConfig.key) {
              const success = await initSupabase(
                supabaseConfig.url,
                supabaseConfig.key
              );
              if (!success) {
                showErrorMessage("Failed to initialize Supabase");
                return false;
              }
            } else {
              // If no saved config, try to get from inputs
              const url = supabaseUrlInput.value.trim();
              const key = supabaseKeyInput.value.trim();

              if (!url || !key) {
                showModal(supabaseConfigModal);
                return false;
              }

              const success = await initSupabase(url, key);
              if (!success) {
                showErrorMessage("Failed to initialize Supabase");
                return false;
              }

              // Save config using Figma's storage via message passing
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "save-supabase-config",
                    url: url,
                    key: key,
                  },
                },
                "*"
              );

              // Update local config
              supabaseConfig = { url, key };
            }
          }

          // Check if Supabase client exists after initialization attempts
          if (!supabaseClient) {
            showErrorMessage("Failed to initialize Supabase client");
            return false;
          }

          // Use device ID instead of user authentication
          const deviceId =
            localStorage.getItem("device_id") || `device-${Date.now()}`;
          localStorage.setItem("device_id", deviceId);

          console.log("Using device ID:", deviceId);

          // Delete existing non-built-in collections first
          const { error: deleteError } = await supabaseClient
            .from("collections")
            .delete()
            .eq("user_id", deviceId)
            .not("is_built_in", true);

          if (deleteError) {
            console.error("Error deleting existing collections:", deleteError);
            showErrorMessage("Error during sync: " + deleteError.message);
            return false;
          }

          // Prepare collections data with device ID
          const collectionsToSync = pluginData.collections
            .filter((collection) => !collection.isBuiltIn)
            .map((collection) => ({
              id: collection.id,
              name: collection.name,
              presets: collection.presets,
              is_built_in: collection.isBuiltIn || false,
              user_id: deviceId,
              last_synced_at: new Date().toISOString(),
            }));

          console.log("Syncing collections:", collectionsToSync.length);

          // If no collections to sync, just return success
          if (collectionsToSync.length === 0) {
            // Update sync status even though no data was synced
            const now = new Date();
            document.querySelector(
              ".sync-status"
            ).textContent = `Last synced: ${now.toLocaleTimeString()}`;
            pluginData.lastSyncedAt = now.getTime();
            return true;
          }

          // Insert collections with device ID
          const { error: upsertError } = await supabaseClient
            .from("collections")
            .upsert(collectionsToSync, {
              onConflict: "id", // Handle conflicts by ID
              ignoreDuplicates: false, // Update existing records
            });

          if (upsertError) {
            console.error("Upsert error:", upsertError);
            showErrorMessage("Error during sync: " + upsertError.message);
            return false;
          }

          // Update sync status
          const now = new Date();
          document.querySelector(
            ".sync-status"
          ).textContent = `Last synced: ${now.toLocaleTimeString()}`;
          pluginData.lastSyncedAt = now.getTime();

          // Notify Figma
          parent.postMessage(
            {
              pluginMessage: {
                type: "sync-to-supabase",
                success: true,
              },
            },
            "*"
          );

          return true;
        } catch (error) {
          console.error("Sync error:", error);
          showErrorMessage("Failed to sync: " + error.message);
          return false;
        }
      }

      // Add function to import from Supabase
      async function importFromSupabase() {
        if (!supabaseClient) {
          showErrorMessage("Please configure Supabase first");
          return false;
        }

        try {
          // Use device ID instead of user authentication
          const deviceId =
            localStorage.getItem("device_id") || `device-${Date.now()}`;
          localStorage.setItem("device_id", deviceId);

          console.log("Using device ID for import:", deviceId);

          // Only get collections that belong to this device
          const { data, error } = await supabaseClient
            .from("collections")
            .select("*")
            .eq("user_id", deviceId)
            .order("created_at", { ascending: true });

          if (error) {
            console.error("Import query error:", error);
            showErrorMessage("Error during import: " + error.message);
            return false;
          }

          if (!data || data.length === 0) {
            showErrorMessage("No collections found for your device");
            return false;
          }

          console.log("Found collections to import:", data.length);

          // Merge with existing collections, avoiding duplicates
          const existingIds = new Set(pluginData.collections.map((c) => c.id));
          const newCollections = data.filter((c) => !existingIds.has(c.id));

          // If all collections exist already
          if (newCollections.length === 0) {
            showErrorMessage("All collections already exist in your workspace");
            return true;
          }

          // Add the collections
          pluginData.collections = [
            ...pluginData.collections,
            ...newCollections,
          ];

          // Update UI
          renderCollections();

          // Notify Figma
          parent.postMessage(
            {
              pluginMessage: {
                type: "update",
                data: pluginData,
              },
            },
            "*"
          );

          return true;
        } catch (error) {
          console.error("Import error:", error);
          showErrorMessage("Failed to import: " + error.message);
          return false;
        }
      }

      // Add function to import from Supabase using a share code
      async function importSharedCollection() {
        try {
          // Get the share code from the input and save it in a variable
          const shareCode = importIdInput.value.trim().toUpperCase();
          if (!shareCode) {
            showErrorMessage("Please enter a valid share code");
            // Focus the input field again
            setTimeout(() => importIdInput.focus(), 10);
            return false;
          }

          // Show loading state
          importCollectionBtn.disabled = true;
          importCollectionBtn.textContent = "Importing...";

          // Initialize Supabase client if needed
          if (!supabaseClient && supabaseConfig.url && supabaseConfig.key) {
            const success = await initSupabase(
              supabaseConfig.url,
              supabaseConfig.key
            );
            if (!success) {
              importCollectionBtn.disabled = false;
              importCollectionBtn.textContent = "Import";
              showErrorMessage("Failed to initialize connection");
              return false;
            }
          }

          // Check if Supabase client exists
          if (!supabaseClient) {
            importCollectionBtn.disabled = false;
            importCollectionBtn.textContent = "Import";
            showErrorMessage("Please configure Supabase first");
            // Focus the input field again
            setTimeout(() => importIdInput.focus(), 10);
            return false;
          }

          // Debug log the actual input
          console.log("Attempting import with code:", shareCode);

          // Execute the query for exact match
          const { data: sharedCollections, error: fetchError } =
            await supabaseClient
              .from("shared_collections")
              .select("*")
              .eq("share_id", shareCode);

          console.log("Query results:", {
            count: sharedCollections?.length || 0,
            error: fetchError?.message,
          });

          // Restore button state
          importCollectionBtn.disabled = false;
          importCollectionBtn.textContent = "Import";

          if (fetchError) {
            console.error(
              "Database error fetching shared collection:",
              fetchError
            );
            showErrorMessage("Database error: " + fetchError.message);
            // Focus the input field again
            setTimeout(() => importIdInput.focus(), 10);
            return false;
          }

          if (!sharedCollections || sharedCollections.length === 0) {
            console.error("No collection found with ID:", shareCode);
            showErrorMessage(
              "Collection not found with this code. Make sure you entered it correctly."
            );
            // Focus the input field again
            setTimeout(() => importIdInput.focus(), 10);
            return false;
          }

          // Use the first result
          const sharedCollection = sharedCollections[0];
          console.log("Found collection:", sharedCollection?.name);

          if (
            !sharedCollection.presets ||
            !Array.isArray(sharedCollection.presets)
          ) {
            console.error(
              "Invalid collection format - missing presets:",
              sharedCollection
            );
            showErrorMessage("The imported collection has an invalid format.");
            setTimeout(() => importIdInput.focus(), 10);
            return false;
          }

          // Check if this collection already exists
          const collectionExists = pluginData.collections.some(
            (c) => c.id === sharedCollection.collection_id
          );

          if (collectionExists) {
            console.log("Collection already exists in workspace");
            showErrorMessage("This collection is already in your workspace");
            // Focus the input field again
            setTimeout(() => importIdInput.focus(), 10);
            return false;
          }

          // Ensure all presets have isFavorite set to false
          const unfavoritedPresets = sharedCollection.presets.map((preset) => ({
            ...preset,
            isFavorite: false, // Explicitly set all presets to not be favorites
          }));

          // Create a new copy of the collection with a new ID to avoid conflicts
          const newCollection = {
            id: "collection-" + Date.now(), // New unique ID
            name: sharedCollection.name + " (Shared)",
            presets: unfavoritedPresets, // Use the unfavorited presets
            isBuiltIn: false,
            dateImported: Date.now(), // Add import date for reference
          };

          console.log("Created new collection object:", {
            id: newCollection.id,
            name: newCollection.name,
            presetCount: newCollection.presets.length,
          });

          // Add the collection to the local data
          pluginData.collections.push(newCollection);

          // Update UI
          console.log("Updating UI with new collection");
          renderCollections();

          // Notify Figma to save the imported collection to client storage
          // This ensures the collection persists after plugin restart
          parent.postMessage(
            {
              pluginMessage: {
                type: "save-imported-collection",
                collection: newCollection,
                data: pluginData, // Send full data for backup
              },
            },
            "*"
          );

          // Close modal and show success message
          hideModal(importCollectionModal);
          showSuccessMessage(
            "Collection imported successfully and saved locally"
          );

          // Reset input for next time
          importIdInput.value = "";

          return true;
        } catch (error) {
          console.error("Import error:", error);
          showErrorMessage(
            "Failed to import: " + (error.message || "Unknown error")
          );

          // Restore button state
          importCollectionBtn.disabled = false;
          importCollectionBtn.textContent = "Import";

          // Focus the input field again
          setTimeout(() => importIdInput.focus(), 10);
          return false;
        }
      }

      // ============================================================
      // Rendering Functions
      // ============================================================

      // Setup drag and drop functionality for collections
      function setupCollectionDragAndDrop() {
        let draggingElement = null;
        let previousOrder = [];

        // Store the current order of collections
        function saveCurrentOrder() {
          const collections = document.querySelectorAll(".collection");
          previousOrder = Array.from(collections)
            .filter((el) => el.querySelector(".collection-header"))
            .map((el) => el.querySelector(".collection-header").dataset.id);
          return previousOrder;
        }

        // Save new order to Figma
        function saveNewOrder() {
          const collections = document.querySelectorAll(".collection");
          const newOrder = Array.from(collections)
            .filter((el) => el.querySelector(".collection-header"))
            .map((el) => el.querySelector(".collection-header").dataset.id)
            .filter((id) => id !== "favorites"); // Filter out the favorites virtual collection

          console.log("Previous order:", previousOrder);
          console.log("New order:", newOrder);

          // Always send the reorder message to make sure it's processed
          parent.postMessage(
            {
              pluginMessage: {
                type: "reorder-collections",
                collectionIds: newOrder,
              },
            },
            "*"
          );
        }

        // Setup drag and drop for each collection header
        document.querySelectorAll(".collection-header").forEach((header) => {
          // Skip favorites collection which shouldn't be draggable
          if (header.dataset.id === "favorites") {
            header.setAttribute("draggable", "false");
            return;
          }

          // Dragstart - when user starts dragging
          header.addEventListener("dragstart", (e) => {
            draggingElement = header.closest(".collection");
            draggingElement.classList.add("dragging");

            // Set data for drag operation
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", header.dataset.id);

            // Store current order
            saveCurrentOrder();

            // Add delay for visual feedback
            setTimeout(() => {
              draggingElement.style.opacity = "0.6";
            }, 0);
          });

          // Dragend - when user releases the element
          header.addEventListener("dragend", () => {
            if (draggingElement) {
              draggingElement.classList.remove("dragging");
              draggingElement.style.opacity = "1";
              draggingElement = null;

              // Remove drag-over styling
              document.querySelectorAll(".collection-header").forEach((h) => {
                h.classList.remove("drag-over");
              });

              // Save the new order
              saveNewOrder();
            }
          });

          // Dragover - as dragged element moves over potential drop targets
          header.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";

            const container = header.closest(".collection");
            if (
              container !== draggingElement &&
              header.dataset.id !== "favorites"
            ) {
              header.classList.add("drag-over");
            }
          });

          // Dragleave - when dragged element leaves a potential drop target
          header.addEventListener("dragleave", () => {
            header.classList.remove("drag-over");
          });

          // Drop - when element is dropped
          header.addEventListener("drop", (e) => {
            e.preventDefault();
            header.classList.remove("drag-over");

            if (!draggingElement) return;

            const targetContainer = header.closest(".collection");
            if (
              targetContainer !== draggingElement &&
              header.dataset.id !== "favorites"
            ) {
              const containers = Array.from(
                document.querySelectorAll(".collection")
              );
              const dragIndex = containers.indexOf(draggingElement);
              const targetIndex = containers.indexOf(targetContainer);

              // Determine if we need to insert before or after
              if (dragIndex < targetIndex) {
                document
                  .querySelector(".collections-container")
                  .insertBefore(draggingElement, targetContainer.nextSibling);
              } else {
                document
                  .querySelector(".collections-container")
                  .insertBefore(draggingElement, targetContainer);
              }
            }
          });
        });
      }

      // Render all collections
      function renderCollections() {
        collectionsContainer.innerHTML = "";

        // Check if pluginData exists before proceeding
        if (!pluginData || !pluginData.collections) {
          collectionsContainer.innerHTML = `<div class="empty-state">Loading collections...</div>`;
          return;
        }

        // Create a virtual Favorites collection at the top
        const favorites = [];

        // Get all favorite presets across collections
        pluginData.collections.forEach((collection) => {
          collection.presets.forEach((preset) => {
            if (preset.isFavorite) {
              favorites.push({
                ...preset,
                collectionId: collection.id,
                collectionName: collection.name,
              });
            }
          });
        });

        // Add Favorites as a virtual collection
        if (favorites.length > 0) {
          const favoritesEl = document.createElement("div");
          favoritesEl.classList.add(`collection`);
          favoritesEl.classList.add(`collection-favorites`);

          // Create favorites collection header
          favoritesEl.innerHTML = `
          <div class="collection-header" data-id="favorites" style="padding: 6px 12px;">
            <div class="arrow" style="margin-left: 0px;"></div>
            <div class="collection-name" style="display: flex; align-items: center; margin-left: 0px;">
              Favorites
            </div>
          </div>
          <div class="collection-content" data-collection-id="favorites">
            <div class="presets-list">
              ${favorites
                .map((preset) => {
                  // Calculate frame preview dimensions for visualization using SVG
                  const maxPreviewSize = 24; // Reduced from 36px to 24px to match regular collections
                  let previewWidth, previewHeight;

                  // Calculate proper dimensions maintaining aspect ratio
                  if (preset.width > preset.height) {
                    previewWidth = maxPreviewSize;
                    previewHeight =
                      (preset.height / preset.width) * maxPreviewSize;
                  } else {
                    previewHeight = maxPreviewSize;
                    previewWidth =
                      (preset.width / preset.height) * maxPreviewSize;
                  }

                  // Create SVG visualization of the frame
                  return `
                <div class="preset-card" data-id="${
                  preset.id
                }" data-collection="${preset.collectionId}">
                  <div class="preset-preview">
                    <svg width="${maxPreviewSize}" height="${maxPreviewSize}" viewBox="0 0 ${maxPreviewSize} ${maxPreviewSize}" xmlns="http://www.w3.org/2000/svg">
                      <rect 
                        x="${(maxPreviewSize - previewWidth) / 2}" 
                        y="${(maxPreviewSize - previewHeight) / 2}" 
                        width="${previewWidth}" 
                        height="${previewHeight}" 
                        class="frame-rect-fill" />
                    </svg>
                  </div>
                  <div class="preset-info">
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-dimensions-row">
                      <button class="favorite-btn active" data-id="${
                        preset.id
                      }" data-collection="${preset.collectionId}">
                        <svg width="16" height="16" viewBox="0 0 12 12" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                          <path d="M5.95 1.37724C5.9776 1.32251 6.0224 1.32251 6.05 1.37724L7.5595 4.42717C7.57224 4.45394 7.59776 4.47125 7.62709 4.47456L10.9639 4.92686C11.0243 4.93462 11.0463 5.00876 11.0012 5.0529L8.55513 7.42616C8.53316 7.44749 8.52325 7.47852 8.52855 7.50779L9.12376 10.8254C9.13402 10.8855 9.07045 10.9328 9.01734 10.9054L6.07474 9.36736C6.0479 9.35256 6.0141 9.35438 5.98869 9.37122L3.10501 11.0304C3.05287 11.0608 2.98701 11.0163 2.99478 10.9559L3.47124 7.61922C3.47551 7.58973 3.46456 7.55909 3.44183 7.53851L0.9422 5.24822C0.895218 5.20623 0.914854 5.13149 0.97477 5.12181L4.29308 4.54424C4.32225 4.53993 4.34671 4.52183 4.35816 4.49471L5.95 1.37724Z" fill="currentColor" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                      </button>
                      <div class="preset-dimensions">${formatDimensions(
                        preset.width,
                        preset.height
                      )}</div>
                    </div>
                  </div>
                </div>
              `;
                })
                .join("")}
            </div>
          </div>
          `;

          collectionsContainer.appendChild(favoritesEl);
        }

        // Then render all regular collections
        pluginData.collections.forEach((collection) => {
          const isActive = collection.id === pluginData.activeCollectionId;
          const collectionEl = document.createElement("div");
          collectionEl.classList.add(`collection`);
          collectionEl.classList.add(`collection-${collection.id}`);

          // Add active class if this collection is active
          if (isActive) {
            collectionEl.classList.add("active-collection");
          }

          // Create collection header in a style similar to the screenshot
          collectionEl.innerHTML = `
          <div class="collection-header" data-id="${
            collection.id
          }" draggable="true">
            <div class="arrow"></div>
            <div class="collection-name">
              ${collection.name}
            </div>
            <div class="collection-header-right">
              <div class="collection-actions">
                <button class="share-collection-btn" data-id="${
                  collection.id
                }" data-tooltip="Share collection">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.68439 10.6578L15.3124 7.34378M15.3156 16.6578L8.69376 13.3469M21 6C21 7.65685 19.6569 9 18 9C16.3431 9 15 7.65685 15 6C15 4.34315 16.3431 3 18 3C19.6569 3 21 4.34315 21 6ZM21 18C21 19.6569 19.6569 21 18 21C16.3431 21 15 19.6569 15 18C15 16.3431 16.3431 15 18 15C19.6569 15 21 16.3431 21 18ZM9 12C9 13.6569 7.65685 15 6 15C4.34315 15 3 13.6569 3 12C3 10.3431 4.34315 9 6 9C7.65685 9 9 10.3431 9 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="delete-collection-btn" data-id="${
                  collection.id
                }" data-tooltip="Delete collection">
                  <svg width="14" height="14" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 3H11M4 3V2.5C4 1.67157 4.67157 1 5.5 1H6.5C7.32843 1 8 1.67157 8 2.5V3M9 3V10C9 10.5523 8.55228 11 8 11H4C3.44772 11 3 10.5523 3 10V3" stroke="currentColor" stroke-width="1.5"/>
                  </svg>
                </button>
                <div class="drag-handle" data-tooltip="Drag to reorder">
                  <svg width="10" height="10" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 5H5M7 10H5M7 15H5M15 5H13M15 10H13M15 15H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>
          <div class="collection-content" data-collection-id="${collection.id}">
            <div class="presets-list">
              ${
                collection.presets.length > 0
                  ? collection.presets
                      .map((preset) => {
                        // Calculate frame preview dimensions for visualization using SVG
                        const maxPreviewSize = 24; // Reduced from 36px to 24px
                        let previewWidth, previewHeight;

                        // Calculate proper dimensions maintaining aspect ratio
                        if (preset.width > preset.height) {
                          previewWidth = maxPreviewSize;
                          previewHeight =
                            (preset.height / preset.width) * maxPreviewSize;
                        } else {
                          previewHeight = maxPreviewSize;
                          previewWidth =
                            (preset.width / preset.height) * maxPreviewSize;
                        }

                        // Create SVG visualization of the frame
                        return `
                <div class="preset-card" data-id="${
                  preset.id
                }" data-collection="${collection.id}">
                  <div class="preset-preview">
                    <svg width="${maxPreviewSize}" height="${maxPreviewSize}" viewBox="0 0 ${maxPreviewSize} ${maxPreviewSize}" xmlns="http://www.w3.org/2000/svg">
                      <rect 
                        x="${(maxPreviewSize - previewWidth) / 2}" 
                        y="${(maxPreviewSize - previewHeight) / 2}" 
                        width="${previewWidth}" 
                        height="${previewHeight}" 
                        class="frame-rect-fill" />
                    </svg>
                  </div>
                  <div class="preset-info">
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-dimensions-row">
                      <button class="favorite-btn ${
                        preset.isFavorite ? "active" : ""
                      }" data-id="${preset.id}" data-collection="${
                          collection.id
                        }" data-tooltip="${
                          preset.isFavorite
                            ? "Remove from favorites"
                            : "Add to favorites"
                        }">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="${
                          preset.isFavorite ? "currentColor" : "none"
                        }" xmlns="http://www.w3.org/2000/svg">
                          <path d="M5.95 1.37724C5.9776 1.32251 6.0224 1.32251 6.05 1.37724L7.5595 4.42717C7.57224 4.45394 7.59776 4.47125 7.62709 4.47456L10.9639 4.92686C11.0243 4.93462 11.0463 5.00876 11.0012 5.0529L8.55513 7.42616C8.53316 7.44749 8.52325 7.47852 8.52855 7.50779L9.12376 10.8254C9.13402 10.8855 9.07045 10.9328 9.01734 10.9054L6.07474 9.36736C6.0479 9.35256 6.0141 9.35438 5.98869 9.37122L3.10501 11.0304C3.05287 11.0608 2.98701 11.0163 2.99478 10.9559L3.47124 7.61922C3.47551 7.58973 3.46456 7.55909 3.44183 7.53851L0.9422 5.24822C0.895218 5.20623 0.914854 5.13149 0.97477 5.12181L4.29308 4.54424C4.32225 4.53993 4.34671 4.52183 4.35816 4.49471L5.95 1.37724Z" fill="currentColor" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                      </button>
                      <div class="preset-dimensions">${formatDimensions(
                        preset.width,
                        preset.height
                      )}</div>
                    </div>
                  </div>
                  ${
                    !collection.isBuiltIn
                      ? `
                  <div class="preset-actions">
                    <button class="delete-preset-btn" data-id="${preset.id}" data-collection="${collection.id}" data-tooltip="Delete preset">
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 3H10M4 3V2.5C4 1.67157 4.67157 1 5.5 1H6.5C7.32843 1 8 1.67157 8 2.5V3M9 3V10C9 10.5523 8.55228 11 8 11H4C3.44772 11 3 10.5523 3 10V3" stroke="currentColor" stroke-width="1.5"/>
                      </svg>
                    </button>
                  </div>
                  `
                      : ""
                  }                
                </div>
              `;
                      })
                      .join("")
                  : `<div class="empty-state" style="border: none; border-top: none; border-bottom: none;">No presets in this collection. Create one using the "Save Current Frame" button.</div>`
              }
            </div>
          </div>
        `;

          collectionsContainer.appendChild(collectionEl);
        });

        // Add premium bundle link after all collections
        const premiumBundleEl = document.createElement("div");
        premiumBundleEl.className = "premium-bundle-link";
        premiumBundleEl.innerHTML = `
          <a href="#" id="premium-bundle-btn">
            <span class="premium-icon">✨</span>
            <strong>Premium Templates & Bundles</strong>
          </a>
        `;
        collectionsContainer.appendChild(premiumBundleEl);

        // Set up event listeners for the newly created elements
        setupCollectionEventListeners();

        // Setup drag and drop for collection reordering
        setupCollectionDragAndDrop();

        // Ensure the active collection remains expanded
        ensureActiveCollectionExpanded();
      }

      // Favorites are now handled directly inside the renderCollections function

      // Ensure the active-collection class is updated when the active collection changes
      function updateActiveCollectionClass() {
        document.querySelectorAll(".collection").forEach((collectionEl) => {
          const collectionId = collectionEl.getAttribute("data-id");
          if (collectionId === pluginData.activeCollectionId) {
            collectionEl.classList.add("active-collection");
          } else {
            collectionEl.classList.remove("active-collection");
          }
        });
      }

      // Set up event listeners for collection elements
      function setupCollectionEventListeners() {
        document.querySelectorAll(".collection-header").forEach((header) => {
          header.addEventListener("click", (e) => {
            e.stopPropagation();

            const collectionId = header.getAttribute("data-id");
            const arrow = header.querySelector(".arrow");
            const contentDiv = document.querySelector(
              `.collection-content[data-collection-id="${collectionId}"]`
            );
            const isExpanded = arrow && arrow.classList.contains("expanded");

            // Handle "Favorites" collection separately
            if (collectionId === "favorites") {
              if (isExpanded) {
                arrow.classList.remove("expanded");
                contentDiv.classList.remove("expanded");
              } else {
                arrow.classList.add("expanded");
                contentDiv.classList.add("expanded");
              }
              pluginData.activeCollectionId = collectionId; // Ensure "Favorites" can also be active
              updateActiveCollectionClass();
              return; // Exit early to avoid affecting other collections
            }

            // Collapse all other collections (except "Favorites")
            document
              .querySelectorAll(".collection-header .arrow")
              .forEach((otherArrow) => {
                const parentHeader = otherArrow.closest(".collection-header");
                const parentCollectionId =
                  parentHeader?.getAttribute("data-id");
                if (
                  parentCollectionId !== "favorites" &&
                  parentCollectionId !== collectionId
                ) {
                  otherArrow.classList.remove("expanded");
                }
              });
            document
              .querySelectorAll(".collection-content.expanded")
              .forEach((otherContent) => {
                const parentContentId =
                  otherContent.getAttribute("data-collection-id");
                if (
                  parentContentId !== "favorites" &&
                  parentContentId !== collectionId
                ) {
                  otherContent.classList.remove("expanded");
                }
              });

            // Toggle the clicked collection's expansion state
            if (isExpanded) {
              arrow.classList.remove("expanded");
              contentDiv.classList.remove("expanded");
            } else {
              arrow.classList.add("expanded");
              contentDiv.classList.add("expanded");
            }

            // Set the clicked collection as active
            pluginData.activeCollectionId = collectionId;
            updateActiveCollectionClass();
          });
        });

        // Delete collection
        document.querySelectorAll(".delete-collection-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const collectionId = btn.getAttribute("data-id");

            if (confirm("Are you sure you want to delete this collection?")) {
              // Notify Figma
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "delete-collection",
                    collectionId: collectionId,
                  },
                },
                "*"
              );
            }
          });
        });

        // Share collection
        document.querySelectorAll(".share-collection-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const collectionId = btn.getAttribute("data-id");
            shareCollection(collectionId);
          });
        });

        // Preset card click (use preset)
        document.querySelectorAll(".preset-card").forEach((card) => {
          card.addEventListener("click", (e) => {
            // Don't use preset if clicking the favorite button or delete button
            if (
              e.target.closest(".favorite-btn") ||
              e.target.closest(".delete-preset-btn")
            )
              return;

            const presetId = card.dataset.id;
            const collectionId = card.dataset.collection;

            const collection = pluginData.collections.find(
              (c) => c.id === collectionId
            );
            if (!collection) return;

            const preset = collection.presets.find((p) => p.id === presetId);
            if (!preset) return;

            // Send the 'apply-preset' message type to handle both applying to selection
            // and creating new frames when nothing is selected
            parent.postMessage(
              {
                pluginMessage: {
                  type: "apply-preset",
                  presetId,
                  collectionId,
                },
              },
              "*"
            );
          });
        });

        // Delete preset button click
        document.querySelectorAll(".delete-preset-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const presetId = btn.getAttribute("data-id");
            const collectionId = btn.getAttribute("data-collection");

            // Get the current expanded state to preserve it during animation
            saveExpandedState();

            // Add a removing animation
            const card = btn.closest(".preset-card");
            if (card) {
              card.classList.add("preset-card-removing");
            }

            // Notify Figma after a short delay for animation
            setTimeout(() => {
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "delete-preset",
                    presetId: presetId,
                    collectionId: collectionId,
                  },
                },
                "*"
              );
            }, 100);
          });
        });

        // Favorite button click
        document.querySelectorAll(".favorite-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const presetId = e.currentTarget.dataset.id;
            const collectionId = e.currentTarget.dataset.collection;
            const card = e.currentTarget.closest(".preset-card");

            // Save expanded state and active collection before toggling
            const activeCollectionId = pluginData.activeCollectionId;
            saveExpandedState();

            // Toggle the favorite state visually immediately for instant feedback
            const isFavorite = e.currentTarget.classList.contains("active");
            if (isFavorite) {
              e.currentTarget.classList.remove("active");
              const svg = e.currentTarget.querySelector("svg");
              if (svg) svg.setAttribute("fill", "transparent");

              // If removing from favorites section, animate removal
              if (card && card.closest(".collection-favorites")) {
                card.classList.add("preset-card-removing");
                // Wait for animation before notifying Figma
                setTimeout(() => {
                  // Notify Figma only after animation starts
                  parent.postMessage(
                    {
                      pluginMessage: {
                        type: "toggle-favorite",
                        presetId,
                        collectionId,
                        preserveActiveCollection: activeCollectionId,
                      },
                    },
                    "*"
                  );
                }, 100); // Short delay for animation to start
                return;
              }
            } else {
              e.currentTarget.classList.add("active");
              const svg = e.currentTarget.querySelector("svg");
              if (svg) svg.setAttribute("fill", "currentColor");
            }

            // Notify Figma while preserving active collection
            parent.postMessage(
              {
                pluginMessage: {
                  type: "toggle-favorite",
                  presetId,
                  collectionId,
                  preserveActiveCollection: activeCollectionId,
                },
              },
              "*"
            );
          });
        });
      }

      // ============================================================
      // Event Listeners
      // ============================================================

      // Theme toggle
      themeToggle.addEventListener("click", toggleTheme);

      // Create new collection
      newCollectionBtn.addEventListener("click", () => {
        // Generate a default collection name based on existing collections
        let nextNumber = 1;

        // Find the highest numbered "Collection X" to determine the next number
        if (
          pluginData &&
          pluginData.collections &&
          pluginData.collections.length > 0
        ) {
          const collectionNameRegex = /^Collection (\d+)$/;

          pluginData.collections.forEach((collection) => {
            const match = collection.name.match(collectionNameRegex);
            if (match) {
              const num = parseInt(match[1], 10);
              if (num >= nextNumber) {
                nextNumber = num + 1;
              }
            }
          });
        }

        // Set the default collection name
        collectionNameInput.value = `Collection ${nextNumber}`;

        // Show the modal and select the text for easy editing
        showModal(newCollectionModal);
        setTimeout(() => {
          collectionNameInput.select();
        }, 100);
      });

      // Save new collection
      saveCollectionBtn.addEventListener("click", () => {
        const name = collectionNameInput.value.trim();
        if (!name) return;

        // Notify Figma
        parent.postMessage(
          {
            pluginMessage: {
              type: "create-collection",
              name,
            },
          },
          "*"
        );

        hideModal(newCollectionModal);

        // If we have a flag to create preset after collection, trigger the preset creation
        if (window.createPresetAfterCollection) {
          // Reset the flag
          window.createPresetAfterCollection = false;

          // Set a timeout to allow the collection to be created first
          setTimeout(() => {
            // We'll request the current selection data from Figma
            // The targetCollectionId will be set in the onmessage handler when we get the update
            parent.postMessage(
              {
                pluginMessage: {
                  type: "create-preset",
                },
              },
              "*"
            );
          }, 300);
        }
      });

      // Cancel new collection
      cancelCollectionBtn.addEventListener("click", () => {
        hideModal(newCollectionModal);
      });

      // Create preset
      createPresetBtn.addEventListener("click", () => {
        // First check if any custom collections exist
        const customCollections = pluginData.collections.filter(
          (c) => !c.isBuiltIn
        );

        // If no custom collections exist, prompt to create one
        if (customCollections.length === 0) {
          if (
            confirm(
              "You need to create a collection first to save frames. Would you like to create one now?"
            )
          ) {
            collectionNameInput.value = "";
            showModal(newCollectionModal);

            // Set a flag to indicate we should create a preset after collection is created
            window.createPresetAfterCollection = true;
          }
          return;
        }

        // If no active collection or active collection is built-in, use the first custom collection
        const activeCollection = pluginData.collections.find(
          (c) => c.id === pluginData.activeCollectionId
        );
        let targetCollectionId = pluginData.activeCollectionId;

        if (!activeCollection || activeCollection.isBuiltIn) {
          targetCollectionId = customCollections[0].id;
          console.log("Using first custom collection:", targetCollectionId);
        }

        // Send the create-preset message directly to Figma
        // This will now automatically save frames without opening the modal
        parent.postMessage(
          {
            pluginMessage: {
              type: "create-preset",
              targetCollectionId: targetCollectionId,
            },
          },
          "*"
        );
      });

      // Save preset
      savePresetBtn.addEventListener("click", () => {
        // Get all frame inputs
        const frameInputGroups =
          document.querySelectorAll(".frame-input-group");

        if (frameInputGroups.length === 0) {
          showErrorMessage("No frames to save");
          return;
        }

        // Store original frame data that came from Figma
        const originalFrameData = window.currentFrameData || [];
        console.log("Original frame data count:", originalFrameData.length);

        // Track the total number of presets to save
        const presetsToSave = [];

        // Loop through each frame input group
        frameInputGroups.forEach((group, index) => {
          const nameInput = group.querySelector(".frame-name-input");
          const widthInput = group.querySelector(".frame-width-input");
          const heightInput = group.querySelector(".frame-height-input");

          if (!nameInput || !widthInput || !heightInput) {
            console.error("Missing input fields");
            return;
          }

          // Get input values
          const name = nameInput.value.trim();
          const width = parseFloat(widthInput.value);
          const height = parseFloat(heightInput.value);

          // Validate
          if (name && !isNaN(width) && !isNaN(height)) {
            // Find the corresponding original frame data for this specific frame
            // Use the index to ensure we match with the correct frame data
            const originalFrame = originalFrameData[index];

            if (!originalFrame) {
              console.error(`Original frame data missing for index ${index}`);
              return;
            }

            console.log(
              `Creating preset for frame ${index}: ${name} (${width}×${height})`
            );

            // Create a completely separate, independent preset object to avoid property sharing
            const preset = {
              id: generateId() + "-" + index, // Ensure unique IDs with index
              name: name,
              width: width,
              height: height,
              isFavorite: false,
              dateCreated: Date.now(),

              // Deep clone all frame properties to break object references
              // This ensures each frame maintains its own unique properties
              fills: JSON.parse(JSON.stringify(originalFrame.fills || [])),
              strokes: JSON.parse(JSON.stringify(originalFrame.strokes || [])),
              strokeWeight: originalFrame.strokeWeight,
              cornerRadius:
                typeof originalFrame.cornerRadius === "object"
                  ? JSON.parse(JSON.stringify(originalFrame.cornerRadius))
                  : originalFrame.cornerRadius,
              effects: JSON.parse(JSON.stringify(originalFrame.effects || [])),
              layoutMode: originalFrame.layoutMode,
              primaryAxisSizingMode: originalFrame.primaryAxisSizingMode,
              counterAxisSizingMode: originalFrame.counterAxisSizingMode,
              primaryAxisAlignItems: originalFrame.primaryAxisAlignItems,
              counterAxisAlignItems: originalFrame.counterAxisAlignItems,
              paddingLeft: originalFrame.paddingLeft,
              paddingRight: originalFrame.paddingRight,
              paddingTop: originalFrame.paddingTop,
              paddingBottom: originalFrame.paddingBottom,
              itemSpacing: originalFrame.itemSpacing,
              clipsContent: originalFrame.clipsContent,
            };

            // Add preset to the list to save
            presetsToSave.push(preset);
          }
        });

        // If we have presets to save, send them all at once to Figma
        if (presetsToSave.length > 0) {
          console.log(`Sending ${presetsToSave.length} presets to Figma`);

          // Notify Figma to save all presets at once
          parent.postMessage(
            {
              pluginMessage: {
                type: "save-multiple-presets",
                presets: presetsToSave,
                collectionId: pluginData.activeCollectionId,
              },
            },
            "*"
          );

          // Show success message
          showSuccessMessage(
            `Saved ${presetsToSave.length} preset${
              presetsToSave.length > 1 ? "s" : ""
            }`
          );
        }

        hideModal(createPresetModal);
      });

      // Cancel preset
      cancelPresetBtn.addEventListener("click", () => {
        hideModal(createPresetModal);
      });

      // Import button
      importBtn.addEventListener("click", () => {
        importIdInput.value = "";
        showModal(importCollectionModal);
      });

      // Import collection
      importCollectionBtn.addEventListener("click", async () => {
        const success = await importSharedCollection();
        if (success) {
          hideModal(importCollectionModal);
          showSuccessMessage("Collection imported successfully");
        } else {
          showErrorMessage("Collection already exists");
        }
      });

      // Cancel import
      cancelImportBtn.addEventListener("click", () => {
        hideModal(importCollectionModal);
      });

      // Copy share link
      copyShareLinkBtn.addEventListener("click", () => {
        try {
          // Method 1: Modern Clipboard API
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(shareLink.textContent)
              .then(() => {
                copyShareLinkBtn.textContent = "Copied!";
                setTimeout(() => {
                  copyShareLinkBtn.textContent = "Copy to Clipboard";
                  // Auto-close the modal after copying
                  hideModal(shareCollectionModal);
                }, 1000);
              })
              .catch((err) => fallbackCopyToClipboard(shareLink.textContent));
          } else {
            // Method 2: Selection and execCommand
            fallbackCopyToClipboard(shareLink.textContent);
          }
        } catch (err) {
          console.error("Copy failed:", err);
          showErrorMessage(
            "Failed to copy. Please select and copy the text manually."
          );
        }
      });

      // Fallback copy method using selection
      function fallbackCopyToClipboard(text) {
        // Create temporary textarea
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.width = "2em";
        textArea.style.height = "2em";
        textArea.style.padding = "0";
        textArea.style.border = "none";
        textArea.style.outline = "none";
        textArea.style.boxShadow = "none";
        textArea.style.background = "transparent";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand("copy");
          if (successful) {
            copyShareLinkBtn.textContent = "Copied!";
            setTimeout(() => {
              copyShareLinkBtn.textContent = "Copy to Clipboard";
              // Auto-close the modal after copying
              hideModal(shareCollectionModal);
            }, 1000);
          } else {
            console.error("Copy command was unsuccessful");
          }
        } catch (err) {
          console.error("Error during copy:", err);
        }

        document.body.removeChild(textArea);
      }

      // Close share modal
      closeShareModalBtn.addEventListener("click", () => {
        hideModal(shareCollectionModal);
      });

      // Test connection button
      checkConnectionBtn.addEventListener("click", async () => {
        if (!supabaseClient) {
          const url = supabaseUrlInput.value.trim();
          const key = supabaseKeyInput.value.trim();

          if (!url || !key) {
            showModal(supabaseConfigModal);
            return;
          }

          const success = await initSupabase(url, key);
          if (!success) {
            showErrorMessage("Failed to initialize Supabase");
            return;
          }
        }

        try {
          const { data, error } = await supabaseClient
            .from("collections")
            .select("*")
            .limit(1);
          if (error) throw error;
          showSuccessMessage("Connection successful!");
        } catch (error) {
          console.error("Connection test error:", error);
          showErrorMessage(
            "Connection failed. Please check your Supabase configuration."
          );
        }
      });

      // Save Supabase config
      saveSupabaseBtn.addEventListener("click", () => {
        const url = supabaseUrlInput.value.trim();
        const key = supabaseKeyInput.value.trim();

        if (!url || !key) {
          showErrorMessage("Please enter both URL and key");
          return;
        }

        supabaseConfig = { url, key };
        hideModal(supabaseConfigModal);

        // After config, try syncing again
        syncToSupabase();
      });

      // Cancel Supabase config
      cancelSupabaseBtn.addEventListener("click", () => {
        hideModal(supabaseConfigModal);
      });

      // Load saved Supabase config on startup - update to avoid multiple initializations
      window.addEventListener("load", () => {
        // Request Supabase config from plugin instead of using localStorage
        parent.postMessage(
          {
            pluginMessage: {
              type: "get-supabase-config",
            },
          },
          "*"
        );
      });

      // ============================================================
      // Message handling from Figma
      // ============================================================
      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;

        if (!msg) return;

        switch (msg.type) {
          case "init":
            // Initialize with data from Figma
            if (msg.data && msg.data.collections) {
              console.log("Received plugin data:", msg.data);
              pluginData = msg.data;
              renderCollections();
            } else {
              console.error("Received invalid plugin data:", msg.data);
              // Set a default empty state if no valid data is received
              collectionsContainer.innerHTML = `<div class="empty-state">Could not load collections. Please restart the plugin.</div>`;
            }
            break;

          case "update":
            // Update data from Figma
            pluginData = msg.data;
            renderCollections();
            break;

          case "inline-name-edit":
            // Handle the inline name edit request
            const inlineNameEditModal = document.getElementById(
              "inline-name-edit-modal"
            );
            const inlineFrameNameInput =
              document.getElementById("inline-frame-name");
            const frameDimensionsInfo = document.getElementById(
              "frame-dimensions-info"
            );
            const saveInlineEditBtn = document.getElementById(
              "save-inline-edit-btn"
            );
            const cancelInlineEditBtn = document.getElementById(
              "cancel-inline-edit-btn"
            );

            // Store frame data for later use
            window.currentFrameData = {
              frameWidth: msg.frameWidth,
              frameHeight: msg.frameHeight,
              targetCollectionId: msg.targetCollectionId,
              frameProps: msg.frameProps,
            };

            // Set the initial name value
            inlineFrameNameInput.value = msg.frameName;

            // Set the dimensions info
            frameDimensionsInfo.textContent = `Frame Dimensions: ${Math.round(
              msg.frameWidth
            )} × ${Math.round(msg.frameHeight)}px`;

            // Show the modal
            showModal(inlineNameEditModal);

            // Select the text in the input for easy editing
            setTimeout(() => {
              inlineFrameNameInput.select();
            }, 100);

            // Set up event listeners
            saveInlineEditBtn.onclick = () => {
              const frameName = inlineFrameNameInput.value.trim();
              if (!frameName) {
                showErrorMessage("Please enter a frame name");
                return;
              }

              // Send message to save the frame with the edited name
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "save-frame-with-name",
                    frameName: frameName,
                    frameWidth: window.currentFrameData.frameWidth,
                    frameHeight: window.currentFrameData.frameHeight,
                    targetCollectionId:
                      window.currentFrameData.targetCollectionId,
                    frameProps: window.currentFrameData.frameProps,
                  },
                },
                "*"
              );

              // Hide the modal
              hideModal(inlineNameEditModal);
            };

            cancelInlineEditBtn.onclick = () => {
              hideModal(inlineNameEditModal);
            };

            // Add keyboard event handlers
            inlineFrameNameInput.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                saveInlineEditBtn.click();
              } else if (e.key === "Escape") {
                cancelInlineEditBtn.click();
              }
            });
            break;

          case "collection-name-exists":
            // Handle duplicate collection name error
            showErrorMessage(
              `Collection name "${msg.name}" already exists. Please use another name.`
            );

            // Re-open the modal and focus the input field
            showModal(newCollectionModal);
            setTimeout(() => {
              // Select the text in the input for easy replacement
              collectionNameInput.select();
              collectionNameInput.focus();
            }, 100);
            break;

          case "active-collection-changed":
            // Only update the active collection state without rerendering
            if (pluginData) {
              pluginData.activeCollectionId = msg.collectionId;

              // Just update the visual active state without full re-render
              document.querySelectorAll(".collection").forEach((coll) => {
                if (coll.classList.contains(`collection-${msg.collectionId}`)) {
                  coll.classList.add("active-collection");
                } else {
                  coll.classList.remove("active-collection");
                }
              });
            }
            break;

          case "supabase-config":
            // Received Supabase configuration from plugin
            if (msg.config && msg.config.url && msg.config.key) {
              // Only update the input fields, don't initialize yet
              supabaseUrlInput.value = msg.config.url;
              supabaseKeyInput.value = msg.config.key;

              // Store the config for later use
              supabaseConfig = msg.config;

              // Only initialize when actually needed (when performing operations)
              console.log(
                "Received Supabase config, will initialize when needed"
              );
            }
            break;

          case "selection-data":
            // This case is no longer used since we're saving frames directly
            // Kept for backward compatibility
            console.log(
              "Received selection-data message - this flow is deprecated"
            );
            break;

          case "no-custom-collections":
            // Handle the case when there are no custom collections
            if (
              confirm(
                "You need to create a collection first to save frames. Would you like to create one now?"
              )
            ) {
              collectionNameInput.value = "";
              showModal(newCollectionModal);

              // Set a flag to indicate we should create a preset after collection is created
              window.createPresetAfterCollection = true;
            }
            break;
        }
      };

      // Function to set frame sizes based on aspect ratios - using the improved scaling approach
      function setFrameSizes() {
        // Get all preset cards
        const presetCards = document.querySelectorAll(".preset-card");

        presetCards.forEach((presetCard) => {
          // Find frame visual in this card
          const frameVisual = presetCard.querySelector(".frame-visual");
          if (!frameVisual) return;

          // Get preset ID and collection ID
          const presetId = presetCard.getAttribute("data-id");
          const collectionId = presetCard.getAttribute("data-collection");

          // Find preset data
          let width = 100;
          let height = 100;

          // Find this preset in the plugin data
          if (pluginData && pluginData.collections) {
            const collection = pluginData.collections.find(
              (c) => c.id === collectionId
            );
            if (collection) {
              const preset = collection.presets.find((p) => p.id === presetId);
              if (preset) {
                width = preset.width;
                height = preset.height;
              }
            }
          }

          // Use the same approach as in the Save Frame modal
          const maxPreviewSize = 30; // Slightly larger than before but still appropriate for the list view
          let previewWidth, previewHeight;

          if (width > height) {
            // Landscape
            previewWidth = maxPreviewSize;
            previewHeight = (height / width) * maxPreviewSize;
          } else {
            // Portrait or square
            previewHeight = maxPreviewSize;
            previewWidth = (width / height) * maxPreviewSize;
          }

          // Set the visual style to match the frame dimensions proportionally
          frameVisual.style.width = `${previewWidth}px`;
          frameVisual.style.height = `${previewHeight}px`;

          // Add a subtle border-radius to match the Figma styling
          frameVisual.style.borderRadius = "2px";
        });
      }

      // Track expanded collections to preserve state during re-renders
      let expandedCollections = [];

      // Function to store current expanded state
      function saveExpandedState() {
        expandedCollections = [];
        document
          .querySelectorAll(".collection-content.expanded")
          .forEach((content) => {
            const collectionId = content.getAttribute("data-collection-id");
            if (collectionId) expandedCollections.push(collectionId);
          });
      }

      // Function to restore expanded state
      function restoreExpandedState() {
        // Ensure we have the active collection expanded
        if (pluginData.activeCollectionId) {
          const activeContentDiv = document.querySelector(
            `.collection-content[data-collection-id="${pluginData.activeCollectionId}"]`
          );
          const activeHeader = document.querySelector(
            `.collection-header[data-id="${pluginData.activeCollectionId}"]`
          );
          if (activeContentDiv) activeContentDiv.classList.add("expanded");
          if (activeHeader) {
            const arrow = activeHeader.querySelector(".arrow");
            if (arrow) arrow.classList.add("expanded");
          }
        }

        // Restore other expanded collections
        expandedCollections.forEach((collectionId) => {
          if (collectionId !== pluginData.activeCollectionId) {
            // Skip active collection as it's already handled
            const contentDiv = document.querySelector(
              `.collection-content[data-collection-id="${collectionId}"]`
            );
            const header = document.querySelector(
              `.collection-header[data-id="${collectionId}"]`
            );
            if (contentDiv) contentDiv.classList.add("expanded");
            if (header) {
              const arrow = header.querySelector(".arrow");
              if (arrow) arrow.classList.add("expanded");
            }
          }
        });
      }

      // Function for smooth UI updates without blinking
      function smoothUpdate(callback) {
        // Execute the update immediately without fade transition
        callback();
      }

      // Apply frame sizing after collections are rendered
      const originalRenderCollections = renderCollections;
      renderCollections = function () {
        // Save expanded state before re-rendering
        saveExpandedState();

        // Call original render function with smooth transition
        smoothUpdate(() => {
          originalRenderCollections.apply(this, arguments);
          // Restore expanded state immediately after rendering
          restoreExpandedState();
          // Apply frame sizing after restoring state
          setFrameSizes();
        });
      };

      // Also apply frame sizing when the UI receives updates
      window.addEventListener("message", function (event) {
        if (
          event.data.pluginMessage &&
          event.data.pluginMessage.type === "update"
        ) {
          // Apply frame sizing after a short delay to ensure DOM is updated
          setTimeout(setFrameSizes, 50);
        }
      });

      // Function to generate a unique short share ID
      async function generateUniqueShareId() {
        // Check if Supabase client exists
        if (!supabaseClient) {
          console.error("Supabase client not initialized");
          // Return a random ID without checking uniqueness
          const characters = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
          let result = "";
          for (let i = 0; i < 6; i++) {
            result += characters.charAt(
              Math.floor(Math.random() * characters.length)
            );
          }
          return result;
        }

        const characters = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // Excluding similar looking characters
        let attempts = 0;
        const maxAttempts = 10;

        while (attempts < maxAttempts) {
          // Generate a 6-character code
          let result = "";
          for (let i = 0; i < 6; i++) {
            result += characters.charAt(
              Math.floor(Math.random() * characters.length)
            );
          }

          try {
            // Check if this ID already exists in the database
            const { data, error } = await supabaseClient
              .from("shared_collections")
              .select("share_id")
              .eq("share_id", result)
              .maybeSingle();

            if (error) {
              console.error("Error checking share ID uniqueness:", error);
              // If there's an error, just return the ID and hope for the best
              return result;
            }

            // If no matching ID found, this ID is unique
            if (!data) {
              return result;
            }
          } catch (err) {
            console.error("Error in generateUniqueShareId:", err);
            return result;
          }

          attempts++;
        }

        // If we've tried too many times, generate a longer ID to ensure uniqueness
        let fallbackId = "";
        for (let i = 0; i < 8; i++) {
          fallbackId += characters.charAt(
            Math.floor(Math.random() * characters.length)
          );
        }
        return fallbackId;
      }

      // Function to share a collection
      async function shareCollection(collectionId) {
        try {
          // Find the collection
          const collection = pluginData.collections.find(
            (c) => c.id === collectionId
          );
          if (!collection) {
            showErrorMessage("Collection not found");
            return;
          }

          // Initialize Supabase client if needed
          if (!supabaseClient && supabaseConfig.url && supabaseConfig.key) {
            const success = await initSupabase(
              supabaseConfig.url,
              supabaseConfig.key
            );
            if (!success) {
              showErrorMessage("Failed to initialize connection");
              return;
            }
          }

          // Check if Supabase client exists
          if (!supabaseClient) {
            showErrorMessage("Please configure Supabase first");
            return;
          }

          // Generate a unique 6-character share ID
          const shareId = await generateUniqueShareId();

          // Create a new entry in the shared_collections table
          const { error } = await supabaseClient
            .from("shared_collections")
            .insert({
              share_id: shareId,
              collection_id: collectionId,
              name: collection.name,
              presets: collection.presets,
            });

          if (error) {
            console.error("Error sharing collection:", error);
            showErrorMessage("Error sharing collection: " + error.message);
            return;
          }

          // Show the share ID
          shareLink.textContent = shareId;
          showModal(shareCollectionModal);
        } catch (error) {
          console.error("Share error:", error);
          showErrorMessage("Failed to share collection: " + error.message);
        }
      }

      // Add non-blocking notification functions
      function showErrorMessage(message) {
        createAndShowNotification(message, "error");
      }

      function showSuccessMessage(message) {
        createAndShowNotification(message, "success");
      }

      function showWarningMessage(message) {
        createAndShowNotification(message, "warning");
      }

      function createAndShowNotification(message, type = "success") {
        // Remove any existing notification of the same type
        const existingNotification = document.getElementById(
          `${type}-notification`
        );
        if (existingNotification) {
          document.body.removeChild(existingNotification);
        }

        // Create new notification element
        const notification = document.createElement("div");
        notification.id = `${type}-notification`;
        notification.className = `notification notification-${type}`;

        // Create icon based on notification type
        const iconContainer = document.createElement("div");
        iconContainer.className = "notification-icon";

        let iconSvg = "";
        switch (type) {
          case "error":
            iconSvg = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 4.5V7.5M7 9.5V9.505M13 7C13 10.3137 10.3137 13 7 13C3.68629 13 1 10.3137 1 7C1 3.68629 3.68629 1 7 1C10.3137 1 13 3.68629 13 7Z" stroke="#F24822" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            break;
          case "success":
            iconSvg = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4.5 7L6.5 9L9.5 5M13 7C13 10.3137 10.3137 13 7 13C3.68629 13 1 10.3137 1 7C1 3.68629 3.68629 1 7 1C10.3137 1 13 3.68629 13 7Z" stroke="#14AE5C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            break;
          case "warning":
            iconSvg = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 4.5V7.5M7 9.5V9.505M7 13C3.68629 13 1 10.3137 1 7C1 3.68629 3.68629 1 7 1C10.3137 1 13 3.68629 13 7C10.3137 13 7 13Z" stroke="#FFBD44" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            break;
        }

        iconContainer.innerHTML = iconSvg;
        notification.appendChild(iconContainer);

        // Add message text
        const messageText = document.createElement("div");
        messageText.textContent = message;
        notification.appendChild(messageText);

        // Add to DOM
        document.body.appendChild(notification);

        // Trigger animation (wait a frame to ensure proper transition)
        requestAnimationFrame(() => {
          notification.classList.add("show");
        });

        // Auto-hide after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          // Remove from DOM after transition
          setTimeout(() => {
            if (notification.parentNode) {
              document.body.removeChild(notification);
            }
          }, 300); // Matches CSS transition time
        }, 3000);
      }

      // Ensure the active collection remains expanded until the plugin is closed
      function ensureActiveCollectionExpanded() {
        if (pluginData.activeCollectionId) {
          const activeArrow = document.querySelector(
            `.collection-${pluginData.activeCollectionId} .arrow`
          );
          const activeContent = document.querySelector(
            `.collection-content[data-collection-id="${pluginData.activeCollectionId}"]`
          );

          if (activeArrow && activeContent) {
            // Only expand if not already expanded
            if (!activeArrow.classList.contains("expanded")) {
              activeArrow.classList.add("expanded");
              activeContent.classList.add("expanded");
            }
            return;
          }
        }

        // If no active collection is set, default to the first collection
        const firstCollection = document.querySelector(".collection");
        if (firstCollection && !pluginData.activeCollectionId) {
          const firstCollectionId = firstCollection.getAttribute("data-id");
          pluginData.activeCollectionId = firstCollectionId;

          const firstArrow = firstCollection.querySelector(".arrow");
          const firstContent = firstCollection.querySelector(
            ".collection-content"
          );

          if (firstArrow && firstContent) {
            firstArrow.classList.add("expanded");
            firstContent.classList.add("expanded");
          }
        }
      }

      // Add keyboard event handlers to modals for accessibility
      function setupModalKeyboardHandling() {
        // New Collection Modal
        collectionNameInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            saveCollectionBtn.click();
          } else if (e.key === "Escape") {
            cancelCollectionBtn.click();
          }
        });

        // Import Collection Modal
        importIdInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            importCollectionBtn.click();
          } else if (e.key === "Escape") {
            cancelImportBtn.click();
          }
        });

        // Share Collection Modal (Escape to close)
        shareCollectionModal.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeShareModalBtn.click();
          } else if (e.key === "Enter" || e.key === " ") {
            copyShareLinkBtn.click();
          }
        });
      }

      // Call this function after the DOM is loaded
      document.addEventListener("DOMContentLoaded", setupModalKeyboardHandling);

      // Buy Me a Coffee button click handler
      document.addEventListener("DOMContentLoaded", () => {
        const bmcButton = document.getElementById("bmc-button");
        if (bmcButton) {
          bmcButton.addEventListener("click", () => {
            // Open Buy Me a Coffee link in a browser window
            parent.postMessage(
              {
                pluginMessage: {
                  type: "open-url",
                  url: "https://www.buymeacoffee.com/habeebrahman",
                },
              },
              "*"
            );
            showSuccessMessage("Opening Buy Me a Coffee page...");
          });
        }

        // Premium bundle link click handler using event delegation
        document.addEventListener("click", (e) => {
          const premiumBundleBtn = e.target.closest("#premium-bundle-btn");
          if (premiumBundleBtn) {
            e.preventDefault();
            // Open premium bundles link in a browser window
            parent.postMessage(
              {
                pluginMessage: {
                  type: "open-url",
                  url: "https://saveframe.gumroad.com/",
                },
              },
              "*"
            );
            showSuccessMessage("Opening premium frame bundles page...");
          }
        });
      });

      // Signal to Figma that the UI is ready
      parent.postMessage({ pluginMessage: { type: "ui-ready" } }, "*");

      // Add keyboard shortcut handler for clearing data (before the closing script tag)

      // Dev tools for clearing data
      document.addEventListener("keydown", async (e) => {
        // Ctrl + Shift + Delete to clear all plugin data
        if (e.ctrlKey && e.shiftKey && e.key === "Delete") {
          if (
            confirm(
              "⚠️ Development: Are you sure you want to clear all plugin data? This cannot be undone."
            )
          ) {
            // Clear the UI
            pluginData = {
              collections: [],
              activeCollectionId: null,
              lastSyncedAt: null,
            };

            // Clear the collections container
            collectionsContainer.innerHTML =
              '<div class="empty-state">No collections. Create one using the "New Collection" button.</div>';

            // Notify Figma to clear storage
            parent.postMessage(
              {
                pluginMessage: {
                  type: "clear-plugin-data",
                },
              },
              "*"
            );

            showSuccessMessage("Plugin data cleared successfully");
          }
        }
      });

      // Settings button and modal
      const settingsBtn = document.getElementById("settings-btn");
      const settingsModal = document.getElementById("settings-modal");
      const closeSettingsBtn = document.getElementById("close-settings-btn");
      const resetPluginBtn = document.getElementById("reset-plugin-btn");

      // Open settings modal
      settingsBtn.addEventListener("click", () => {
        showModal(settingsModal);
      });

      // Close settings modal
      closeSettingsBtn.addEventListener("click", () => {
        hideModal(settingsModal);
      });

      // Reset plugin to defaults
      resetPluginBtn.addEventListener("click", () => {
        if (
          confirm(
            "Are you sure you want to reset the plugin to defaults? All your custom collections will be deleted."
          )
        ) {
          parent.postMessage(
            {
              pluginMessage: {
                type: "clear-plugin-data",
              },
            },
            "*"
          );
          hideModal(settingsModal);
          showSuccessMessage("Plugin data has been reset to defaults");
        }
      });

      // Help button and modal functionality
      const helpButton = document.getElementById("help-button");
      const helpModal = document.getElementById("help-modal");
      const closeHelpBtn = document.getElementById("close-help-btn");

      helpButton.addEventListener("click", () => {
        showModal(helpModal);
      });

      closeHelpBtn.addEventListener("click", () => {
        hideModal(helpModal);
      });
    </script>
  </body>
</html>
